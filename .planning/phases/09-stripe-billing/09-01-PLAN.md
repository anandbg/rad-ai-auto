---
phase: 09-stripe-billing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/app/api/billing/checkout/route.ts
  - app/app/api/billing/portal/route.ts
autonomous: true

must_haves:
  truths:
    - "User can click Upgrade and reach Stripe Checkout"
    - "User can click Manage Subscription and reach Stripe Customer Portal"
    - "Checkout creates Stripe customer if none exists"
  artifacts:
    - path: "app/app/api/billing/checkout/route.ts"
      provides: "Stripe Checkout session creation"
      exports: ["POST"]
    - path: "app/app/api/billing/portal/route.ts"
      provides: "Stripe Customer Portal session creation"
      exports: ["POST"]
  key_links:
    - from: "billing/page.tsx handleUpgrade"
      to: "/api/billing/checkout"
      via: "fetch POST with priceId"
      pattern: "fetch.*api/billing/checkout"
    - from: "billing/page.tsx handleManageSubscription"
      to: "/api/billing/portal"
      via: "fetch POST"
      pattern: "fetch.*api/billing/portal"
    - from: "/api/billing/checkout"
      to: "subscriptions table"
      via: "upsert stripe_customer_id"
      pattern: "supabase.*subscriptions.*upsert"

user_setup:
  - service: stripe
    why: "Payment processing requires API keys and webhook configuration"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard → Developers → API keys → Secret key (sk_test_...)"
      - name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard → Developers → API keys → Publishable key (pk_test_...)"
      - name: STRIPE_PRICE_ID_PLUS
        source: "Stripe Dashboard → Products → Plus Plan → Price ID (price_...)"
      - name: STRIPE_PRICE_ID_PRO
        source: "Stripe Dashboard → Products → Pro Plan → Price ID (price_...)"
    account_setup:
      - url: "https://dashboard.stripe.com/register"
        skip_if: "Already have Stripe account"
    dashboard_config:
      - task: "Create Plus product with $15/month price"
        location: "Stripe Dashboard → Products → Add product"
        details: "Name: Plus, Price: $15 recurring monthly"
      - task: "Create Pro product with $35/month price"
        location: "Stripe Dashboard → Products → Add product"
        details: "Name: Pro, Price: $35 recurring monthly"
    local_dev:
      - "stripe listen --forward-to localhost:3000/api/stripe/webhook"
---

<objective>
Create Stripe Checkout and Customer Portal API endpoints for subscription management.

Purpose: Enable users to subscribe to paid plans and manage their subscriptions through Stripe's hosted pages.
Output: Two working API endpoints that redirect users to Stripe Checkout and Customer Portal.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing implementation patterns
@app/app/api/billing/invoices/route.ts
@app/app/api/stripe/webhook/route.ts
@app/app/(protected)/billing/page.tsx

# Database schema reference
@app/supabase/migrations/20260116010000_initial_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stripe Checkout endpoint</name>
  <files>app/app/api/billing/checkout/route.ts</files>
  <action>
    Create POST endpoint at /api/billing/checkout that:

    1. Accept JSON body: { priceId: string }
    2. Authenticate user via Supabase server client
    3. Return 401 if not authenticated
    4. Return 400 if priceId missing or invalid

    5. Check if user has existing Stripe customer:
       - Query subscriptions table for user_id
       - If stripe_customer_id exists, use it
       - If not, create new Stripe customer via stripe.customers.create({
           email: user.email,
           metadata: { user_id: user.id }
         })

    6. Upsert to subscriptions table:
       - user_id, stripe_customer_id, plan='free', status='active'
       - period_start/period_end = now() (will be updated by webhook)

    7. Create Stripe Checkout session:
       - stripe.checkout.sessions.create({
           customer: stripeCustomerId,
           mode: 'subscription',
           payment_method_types: ['card'],
           line_items: [{ price: priceId, quantity: 1 }],
           success_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing?success=true`,
           cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing?canceled=true`,
           metadata: { user_id: user.id }
         })

    8. Return JSON: { url: session.url }

    Security: Validate priceId against known price IDs (STRIPE_PRICE_ID_PLUS, STRIPE_PRICE_ID_PRO)

    Follow pattern from invoices/route.ts for Stripe client initialization and error handling.
  </action>
  <verify>
    - TypeScript compiles without errors: cd app && pnpm typecheck
    - Endpoint returns 401 without auth
    - Endpoint returns 400 with missing priceId
    - Endpoint returns { url: string } with valid inputs (manual test with Stripe test mode)
  </verify>
  <done>POST /api/billing/checkout creates Stripe Checkout session and returns URL</done>
</task>

<task type="auto">
  <name>Task 2: Create Stripe Customer Portal endpoint</name>
  <files>app/app/api/billing/portal/route.ts</files>
  <action>
    Create POST endpoint at /api/billing/portal that:

    1. Authenticate user via Supabase server client
    2. Return 401 if not authenticated

    3. Get user's stripe_customer_id from subscriptions table:
       - Query subscriptions where user_id = user.id
       - Return 400 with message "No subscription found" if no record
       - Return 400 with message "No Stripe customer linked" if no stripe_customer_id

    4. Create Stripe billing portal session:
       - stripe.billingPortal.sessions.create({
           customer: stripeCustomerId,
           return_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing`
         })

    5. Return JSON: { url: session.url }

    Error handling: Return appropriate error messages for:
    - Stripe not configured (500)
    - User not found (401)
    - No subscription/customer (400)
    - Stripe API error (500 with logged details)

    Follow same patterns as checkout endpoint for consistency.
  </action>
  <verify>
    - TypeScript compiles without errors: cd app && pnpm typecheck
    - Endpoint returns 401 without auth
    - Endpoint returns 400 if user has no subscription
    - Endpoint returns { url: string } for users with stripe_customer_id
  </verify>
  <done>POST /api/billing/portal creates Stripe Customer Portal session and returns URL</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd app && pnpm typecheck` passes without errors
- [ ] `cd app && pnpm build` completes successfully
- [ ] Both API routes exist and export POST handlers
- [ ] Checkout endpoint handles: auth, validation, customer creation, session creation
- [ ] Portal endpoint handles: auth, customer lookup, session creation
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Checkout creates Stripe sessions with correct URLs
- Portal creates billing portal sessions
- Customer ID saved to subscriptions table during checkout
</success_criteria>

<output>
After completion, create `.planning/phases/09-stripe-billing/09-01-SUMMARY.md`
</output>
