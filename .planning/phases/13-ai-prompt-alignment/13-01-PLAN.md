---
phase: 13-ai-prompt-alignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/app/api/generate/route.ts
  - app/app/api/templates/suggest/route.ts
autonomous: true

must_haves:
  truths:
    - "Report generation includes anti-hallucination rules from reference"
    - "Report generation supports template syntax (placeholders, instructions, verbatim)"
    - "Report generation includes contradiction prevention logic"
    - "Template suggestions include template syntax guidance"
  artifacts:
    - path: "app/app/api/generate/route.ts"
      provides: "Production-quality report generation system prompt"
      contains: "ANTI-HALLUCINATION"
    - path: "app/app/api/templates/suggest/route.ts"
      provides: "Enhanced template suggestion prompts"
      contains: "Template syntax"
  key_links:
    - from: "app/app/api/generate/route.ts"
      to: "reference/ai-prompts-reference.md"
      via: "System prompt alignment"
      pattern: "CRITICAL ANTI-HALLUCINATION RULES"
---

<objective>
Align AI system prompts with reference documentation for production-quality medical outputs.

Purpose: The current prompts are minimal prototypes. The reference documentation (`.planning/reference/ai-prompts-reference.md`) contains comprehensive, tested prompts with anti-hallucination rules, contradiction prevention, and template syntax handling that are critical for production medical AI.

Output: Updated `/api/generate` and `/api/templates/suggest` routes with production-quality system prompts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference documentation containing target prompts:
@.planning/reference/ai-prompts-reference.md

# Current implementation files:
@app/app/api/generate/route.ts
@app/app/api/templates/suggest/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Align report generation system prompt with reference</name>
  <files>app/app/api/generate/route.ts</files>
  <action>
Update the system prompt in `/api/generate/route.ts` to align with the reference documentation in `.planning/reference/ai-prompts-reference.md` Section 2.

Key changes to make:

1. **Replace the current simple prompt** with the comprehensive reference prompt including:
   - Expert radiologist persona with 20+ years experience
   - CRITICAL ANTI-HALLUCINATION RULES (full section from reference)
   - REPORTING STANDARDS section
   - CLINICAL REASONING section
   - CONTRADICTION PREVENTION section
   - NORMAL FINDINGS INTEGRATION section
   - FORBIDDEN OUTPUT PATTERNS section

2. **Keep the current request schema** but enhance the prompt to use template info:
   - Template Name, Modality, Body Part are already passed
   - Add template content reference if provided

3. **Maintain Markdown output format** since Phase 12 already established react-markdown rendering (don't switch to JSON output - the reference shows JSON but our UI expects markdown)

4. **Keep temperature at 0.2** (matches reference for deterministic medical reports)

5. **Key sections to include from reference:**
   ```
   CRITICAL ANTI-HALLUCINATION RULES (MUST FOLLOW):
   - ONLY report findings that are EXPLICITLY mentioned in the USER FINDINGS / DICTATION section
   - NEVER invent, assume, or infer abnormalities...
   [Include all 7 bullet points and 4 examples from reference]

   CONTRADICTION PREVENTION (CRITICAL):
   - If you mention an abnormality in an organ, do NOT say that organ is "normal"
   [Include all 5 bullet points from reference]

   NORMAL FINDINGS INTEGRATION:
   - Start with user's positive findings (abnormalities first)
   [Include all 5 bullet points from reference]
   ```

6. **Adapt user prompt** to include the anti-hallucination reminder:
   ```
   ⚠️ CRITICAL SOURCE OF TRUTH ⚠️
   The text above is the ONLY source of findings. You MUST NOT report any abnormality, measurement, or specific detail that is not explicitly stated in the USER FINDINGS / DICTATION section above.
   ```

DO NOT change the output format to JSON - keep Markdown output since the workspace UI uses react-markdown for rendering.
  </action>
  <verify>
1. Review the updated route.ts to confirm all reference sections are included
2. Run `cd app && npm run build` to ensure no TypeScript errors
3. Grep for "ANTI-HALLUCINATION" to confirm key section is present
  </verify>
  <done>
- System prompt includes CRITICAL ANTI-HALLUCINATION RULES with all examples
- System prompt includes CONTRADICTION PREVENTION section
- System prompt includes NORMAL FINDINGS INTEGRATION guidelines
- System prompt includes FORBIDDEN OUTPUT PATTERNS
- Build passes without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance template suggestion prompts with syntax guidance</name>
  <files>app/app/api/templates/suggest/route.ts</files>
  <action>
Update the `buildSystemPrompt` function in `/api/templates/suggest/route.ts` to include template syntax guidance from reference documentation Section 3 and 7.

Key changes to make:

1. **Add template syntax reference to all request types** (sections, improvements, normalFindings):
   ```
   Template syntax (radiologists use these patterns):
   - Placeholders: [like this] for dynamic content filled by AI
     Examples: [patient age], [lesion size], [measurement]
   - Instructions: (like this) for conditional guidance
     Examples: (only include if mentioned), (leave blank if not applicable)
   - Verbatim: "like this" for exact phrases that should appear every time
     Examples: "No acute abnormality.", "The study was performed using standard technique."
   ```

2. **For 'sections' request type**, add guidance about section types:
   ```
   Section types to consider:
   - Regular sections: Content with placeholders and instructions
   - Heading-only sections: Title without generated content (empty content)
   - Parent heading sections: Grouping headers with Guidance: prefix
   ```

3. **For 'improvements' request type**, add syntax-aware improvement suggestions:
   ```
   When suggesting improvements, check:
   - Are placeholders used for dynamic content?
   - Are instructions used for conditional content?
   - Are standard phrases wrapped in verbatim quotes?
   - Are heading-only sections used where appropriate?
   ```

4. **For 'normalFindings' request type**, enhance to mention integration pattern:
   ```
   Normal findings will be integrated by the report generator:
   - Added only for structures NOT mentioned in user findings
   - Modified to avoid contradictions with positive findings
   - Written as experienced radiologist would dictate
   ```

5. **Keep temperature at 0.3** for template suggestions (matches reference for slight creativity)
  </action>
  <verify>
1. Review the updated route.ts to confirm syntax guidance is added
2. Run `cd app && npm run build` to ensure no TypeScript errors
3. Grep for "Template syntax" to confirm guidance section is present
  </verify>
  <done>
- All three request types include template syntax reference
- Sections type includes heading-only and parent heading guidance
- Improvements type includes syntax-aware suggestions
- Normal findings type includes integration pattern context
- Build passes without errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd app && npm run build` succeeds without errors
- [ ] `grep -r "ANTI-HALLUCINATION" app/app/api/generate/route.ts` shows the section
- [ ] `grep -r "Template syntax" app/app/api/templates/suggest/route.ts` shows the guidance
- [ ] No TypeScript errors in either modified file
</verification>

<success_criteria>
- Both tasks completed with atomic commits
- Report generation prompt includes all critical safety sections from reference
- Template suggestion prompts include syntax guidance
- Build passes without errors
- V1.1-AI-01 requirement addressed
</success_criteria>

<output>
After completion, create `.planning/phases/13-ai-prompt-alignment/13-01-SUMMARY.md`
</output>
