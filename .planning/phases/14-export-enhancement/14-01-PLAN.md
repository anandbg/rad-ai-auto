---
phase: 14-export-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/workspace/report-workspace.tsx
  - app/package.json
autonomous: false

must_haves:
  truths:
    - "User can click Export PDF and a PDF file downloads directly (no print dialog)"
    - "PDF contains report content with professional medical formatting"
    - "PDF includes institution branding (name, address, footer) from user's brand template"
    - "User can click Download Word and a .docx file downloads"
    - "Word document contains report with proper formatting and institution branding"
    - "Both export options only appear when a report has been generated"
  artifacts:
    - path: "app/components/workspace/report-workspace.tsx"
      provides: "Export buttons and download handlers with brand template support"
      contains: "handleExportPDF.*jspdf|handleExportWord.*docx|brandTemplate|institutionName"
  key_links:
    - from: "Export PDF button"
      to: "jsPDF Blob download"
      via: "html2canvas capture → jsPDF → saveAs"
      pattern: "saveAs.*\\.pdf"
    - from: "Download Word button"
      to: "docx file download"
      via: "docx Document creation → Packer → saveAs"
      pattern: "saveAs.*\\.docx"
    - from: "Export handlers"
      to: "Brand template storage"
      via: "localStorage brand template lookup"
      pattern: "getStoredBrandTemplates|brandTemplate"
---

<objective>
Implement professional document export with direct PDF download (no print dialog) and Word/DOCX download option, applying user's brand template (institution name, address, custom footer, colors).

Purpose: Complete v1.1 production readiness by providing radiologists with professionally branded export options that work seamlessly without browser print dialogs.

Output: Export PDF button triggers direct .pdf download, Download Word button triggers .docx download. Both produce professional medical documents with institution branding from the user's default brand template.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context - workspace wiring
@.planning/phases/12-workspace-consolidation/12-02-SUMMARY.md

# Current implementation to modify
@app/components/workspace/report-workspace.tsx
@app/package.json

# Brand templates reference (for branding structure)
@app/app/(protected)/brand-templates/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add jsPDF/html2canvas and implement branded PDF download</name>
  <files>app/package.json, app/components/workspace/report-workspace.tsx</files>
  <action>
    1. Install jsPDF and html2canvas: `pnpm add jspdf html2canvas`
    2. Install types: `pnpm add -D @types/jspdf`
    3. In report-workspace.tsx, add brand template loading:
       - Define BrandTemplate interface matching brand-templates/page.tsx
       - Add function to get default brand template from localStorage:
         ```typescript
         function getDefaultBrandTemplate(userId: string | undefined): BrandTemplate | null {
           const key = userId ? `ai-rad-brand-templates-${userId}` : 'ai-rad-brand-templates';
           const stored = localStorage.getItem(key);
           if (!stored) return null;
           const templates = JSON.parse(stored);
           return templates.find((t: BrandTemplate) => t.isDefault) || templates[0] || null;
         }
         ```
    4. Update handleExportPDF to:
       - Get user's default brand template
       - Create a hidden div with the report content styled for PDF
       - **Header section:**
         - Institution name (from brandTemplate.institutionName or fallback "Medical Center")
         - Institution address (from brandTemplate.institutionAddress)
         - Template name, modality, body part
         - Generation date
         - Use brandTemplate.primaryColor for header accent/border
       - **Report content:**
         - Parse markdown to styled HTML
         - Use brandTemplate.fontFamily or fallback to Georgia
       - **Footer section:**
         - brandTemplate.footerText (or default "This report is AI-generated...")
         - AI-generated indicator
       - Use html2canvas to capture the styled div
       - Use jsPDF to create PDF from canvas
       - Trigger download with `pdf.save('radiology-report-{timestamp}.pdf')`
       - Clean up hidden div after export
    5. Remove the window.print() call entirely

    Filename format: `radiology-report-{timestamp}.pdf` using ISO date format
  </action>
  <verify>
    - pnpm install succeeds
    - No TypeScript errors: `cd app && pnpm tsc --noEmit`
    - Build succeeds: `cd app && pnpm build`
  </verify>
  <done>
    - jsPDF and html2canvas installed
    - handleExportPDF creates branded PDF via canvas capture
    - PDF downloads directly without print dialog
    - PDF includes institution name, address, custom footer from brand template
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement branded Word/DOCX export</name>
  <files>app/components/workspace/report-workspace.tsx</files>
  <action>
    1. Import docx components: Document, Paragraph, TextRun, HeadingLevel, Packer, AlignmentType, Header, Footer
    2. Import saveAs from file-saver (already installed)
    3. Add handleExportWord function:
       - Get user's default brand template (same function as PDF)
       - Create Document with sections:
       - **Header (docx Header):**
         - Institution name (bold, larger font)
         - Institution address
         - Horizontal rule
       - **Document body:**
         - Report metadata: Template, Modality, Body Part, Date
         - Blank line
         - Parse markdown content to docx paragraphs:
           - ## headings → HeadingLevel.HEADING_2
           - ### headings → HeadingLevel.HEADING_3
           - **bold** → TextRun with bold: true
           - - bullet items → Paragraph with bullet: { level: 0 }
           - Regular text → Paragraph
       - **Footer (docx Footer):**
         - brandTemplate.footerText
         - "AI-Generated Report"
       - Use Packer.toBlob() then saveAs()
    4. Add "Download Word" button next to Export PDF button in the header
       - Similar styling to Export PDF button
       - FileText icon
       - Disabled when no reportContent

    Filename format: `radiology-report-{timestamp}.docx`
  </action>
  <verify>
    - No TypeScript errors: `cd app && pnpm tsc --noEmit`
    - Build succeeds: `cd app && pnpm build`
  </verify>
  <done>
    - handleExportWord function implemented with branding
    - "Download Word" button appears next to Export PDF
    - Button disabled when no report content
    - DOCX includes institution header, custom footer from brand template
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Direct PDF download (no print dialog) and Word/DOCX export with institution branding
  </what-built>
  <how-to-verify>
    1. Run: `cd app && pnpm dev`
    2. Visit: http://localhost:3000/dashboard
    3. In workspace, add some text to transcription
    4. Select a template and click "Generate Report"
    5. Wait for report to complete

    **Test PDF Export:**
    6. Click "Export PDF" button
    7. Verify: PDF file downloads directly (NO print dialog appears)
    8. Open PDF and confirm:
       - **Header shows institution name** (e.g., "City Medical Center")
       - **Header shows institution address**
       - Template/modality/date info present
       - Report content properly formatted
       - **Footer shows custom footer text** from brand template
       - AI-generated indicator in footer

    **Test Word Export:**
    9. Click "Download Word" button
    10. Verify: .docx file downloads
    11. Open in Word/Google Docs and confirm:
        - **Header with institution name and address**
        - Proper headings and formatting
        - Bold text preserved
        - **Footer with brand template footer text**

    **Test disabled state:**
    12. Click "Clear" to remove the report
    13. Verify: Both export buttons are disabled

    **Optional: Test brand template changes:**
    14. Visit: http://localhost:3000/brand-templates
    15. Edit default template institution name
    16. Return to dashboard, generate new report, export
    17. Verify: New institution name appears in exports
  </how-to-verify>
  <resume-signal>Type "approved" if both exports work correctly with branding, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd app && pnpm install` succeeds
- [ ] `cd app && pnpm tsc --noEmit` passes
- [ ] `cd app && pnpm build` succeeds
- [ ] PDF downloads directly without print dialog
- [ ] PDF includes institution branding from brand template
- [ ] DOCX downloads with proper formatting
- [ ] DOCX includes institution branding from brand template
- [ ] Both buttons disabled when no report content
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human approved both export formats with branding
- No errors or warnings introduced
- Export buttons work only when report exists
- Institution branding appears in both export formats
</success_criteria>

<output>
After completion, create `.planning/phases/14-export-enhancement/14-01-SUMMARY.md`
</output>
