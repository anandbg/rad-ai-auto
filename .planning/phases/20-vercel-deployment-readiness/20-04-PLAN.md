---
phase: 20-vercel-deployment-readiness
plan: 04
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - app/next.config.mjs
  - app/middleware.ts
autonomous: true
must_haves:
  truths:
    - "Security headers configured for all routes"
    - "HTTPS-only cookies enforced in production"
    - "Content Security Policy headers set appropriately"
  artifacts:
    - path: "app/next.config.mjs"
      provides: "Comprehensive security headers"
      contains: "Strict-Transport-Security"
    - path: "app/middleware.ts"
      provides: "Additional runtime security checks"
  key_links:
    - from: "next.config.mjs headers"
      to: "HTTP responses"
      via: "Next.js headers() config"
      pattern: "headers.*return"
---

<objective>
Harden the application for production with comprehensive security headers and cookie security.

Purpose: Protect against common web vulnerabilities (XSS, clickjacking, MIME sniffing).
Output: Production-ready security configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md

Relevant source files:
@app/next.config.mjs
@app/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure comprehensive security headers</name>
  <files>app/next.config.mjs</files>
  <action>
Update the `headers()` function in `app/next.config.mjs` to include comprehensive security headers for all routes:

```javascript
async headers() {
  return [
    {
      // Apply to all routes
      source: '/:path*',
      headers: [
        // Prevent clickjacking
        { key: 'X-Frame-Options', value: 'DENY' },
        // Prevent MIME type sniffing
        { key: 'X-Content-Type-Options', value: 'nosniff' },
        // Control referrer information
        { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
        // DNS prefetching for performance
        { key: 'X-DNS-Prefetch-Control', value: 'on' },
        // Enforce HTTPS (Vercel handles this, but belt-and-suspenders)
        {
          key: 'Strict-Transport-Security',
          value: 'max-age=31536000; includeSubDomains'
        },
        // Control browser features
        {
          key: 'Permissions-Policy',
          value: 'camera=(), microphone=(self), geolocation=()'
        },
      ],
    },
    {
      // API-specific headers (more restrictive framing)
      source: '/api/:path*',
      headers: [
        { key: 'X-Frame-Options', value: 'DENY' },
        { key: 'X-Content-Type-Options', value: 'nosniff' },
        { key: 'Cache-Control', value: 'no-store, max-age=0' },
      ],
    },
  ];
},
```

Note: We allow microphone=(self) for voice transcription feature but deny camera and geolocation.

Do NOT add a restrictive Content-Security-Policy yet - it requires careful tuning for inline scripts, Supabase, Stripe, etc. That can be added as a future enhancement.
  </action>
  <verify>grep -A 30 "async headers" app/next.config.mjs</verify>
  <done>Security headers configured for all routes with HSTS, X-Frame-Options, and Permissions-Policy</done>
</task>

<task type="auto">
  <name>Task 2: Clean up ESLint console warnings</name>
  <files>
    app/app/(protected)/settings/page.tsx,
    app/app/(protected)/templates/[id]/page.tsx,
    app/app/(protected)/templates/new/page.tsx,
    app/app/api/stripe/webhook/route.ts
  </files>
  <action>
The build shows many "Unexpected console statement" warnings. For production readiness:

1. **For webhook route (`app/app/api/stripe/webhook/route.ts`):**
   Keep console.log statements but wrap in a conditional or replace with a proper logger pattern:
   ```typescript
   // At top of file
   const log = process.env.NODE_ENV === 'development'
     ? console.log.bind(console, '[Stripe Webhook]')
     : () => {};

   // Then use: log('Event received:', event.type);
   ```

2. **For page components (settings, templates):**
   Remove debug console.log statements that were used during development.
   Search for `console.log` and `console.error` in these files.
   - Keep error logging for genuine errors
   - Remove debug logging for normal operations

3. **For indexeddb.ts and use-session-timeout.ts:**
   Replace console.log with conditional logging or remove debug statements.

Don't spend excessive time on this - remove obvious debug statements, but don't over-engineer logging. The goal is reducing noise in production, not perfect logging infrastructure.
  </action>
  <verify>cd app && pnpm build 2>&1 | grep -c "Unexpected console statement"</verify>
  <done>Console warning count significantly reduced (target: < 10 warnings)</done>
</task>

<task type="auto">
  <name>Task 3: Verify Supabase cookie security</name>
  <files>app/lib/supabase/server.ts, app/lib/supabase/middleware.ts</files>
  <action>
Review Supabase client configuration to ensure cookies are secure in production:

1. Check `app/lib/supabase/server.ts` and `app/lib/supabase/middleware.ts`
2. Verify the cookie options used for session management

Supabase SSR library handles most of this automatically, but verify:
- Cookies should be `httpOnly: true` (prevents XSS access)
- Cookies should be `secure: true` in production (HTTPS only)
- `sameSite: 'lax'` is appropriate for most cases

The @supabase/ssr library configures these correctly by default. Just verify the configuration looks correct:

```typescript
// This pattern should exist in the cookie handling
{
  get(name: string) { ... },
  set(name: string, value: string, options: CookieOptions) {
    // Verify options include secure settings
  },
  remove(name: string, options: CookieOptions) { ... },
}
```

If the existing implementation uses @supabase/ssr correctly, no changes needed - just verify.
  </action>
  <verify>grep -A 20 "createServerClient\|cookieOptions" app/lib/supabase/server.ts app/lib/supabase/middleware.ts</verify>
  <done>Supabase cookie configuration verified as secure (httpOnly, secure in prod, sameSite)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Security headers configured in next.config.mjs
- [ ] HSTS header present
- [ ] Permissions-Policy configured
- [ ] Console warnings reduced
- [ ] Supabase cookie security verified
</verification>

<success_criteria>

- All tasks completed
- Security headers applied to all routes
- Console log warnings significantly reduced
- Cookie security verified
  </success_criteria>

<output>
After completion, create `.planning/phases/20-vercel-deployment-readiness/20-04-SUMMARY.md`
</output>
