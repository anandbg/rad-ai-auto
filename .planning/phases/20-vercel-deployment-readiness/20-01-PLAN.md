---
phase: 20-vercel-deployment-readiness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/app/api/templates/list/route.ts
  - app/app/api/admin/users/route.ts
  - app/app/api/admin/stats/route.ts
  - app/app/api/preferences/route.ts
  - app/app/api/billing/invoices/route.ts
  - app/app/(protected)/generate/page.tsx
  - app/app/(protected)/templates/page.tsx
autonomous: true
must_haves:
  truths:
    - "Build completes with zero errors"
    - "All API routes render dynamically (no static generation errors)"
    - "useSearchParams pages wrapped in Suspense boundaries"
  artifacts:
    - path: "app/app/api/templates/list/route.ts"
      provides: "Dynamic route configuration"
      contains: "dynamic = 'force-dynamic'"
    - path: "app/app/(protected)/generate/page.tsx"
      provides: "Suspense-wrapped page component"
      contains: "Suspense"
  key_links:
    - from: "API routes"
      to: "Vercel build"
      via: "dynamic export config"
      pattern: "export const dynamic"
---

<objective>
Fix all build errors that prevent Vercel deployment: dynamic server usage errors in API routes and useSearchParams CSR bailout errors.

Purpose: Build must complete without errors for Vercel deployment to succeed.
Output: Clean `pnpm build` with zero errors.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STACK.md
@.planning/codebase/ARCHITECTURE.md

Relevant source files:
@app/app/api/templates/list/route.ts
@app/app/api/admin/users/route.ts
@app/app/(protected)/generate/page.tsx
@app/app/(protected)/templates/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dynamic route config to API routes</name>
  <files>
    app/app/api/templates/list/route.ts,
    app/app/api/admin/users/route.ts,
    app/app/api/admin/stats/route.ts,
    app/app/api/preferences/route.ts,
    app/app/api/billing/invoices/route.ts
  </files>
  <action>
Add `export const dynamic = 'force-dynamic';` to each API route that uses cookies/auth.

For each file listed:
1. Add at the top (after imports): `export const dynamic = 'force-dynamic';`
2. This tells Next.js to always render these routes dynamically, not at build time.

These routes use `createSupabaseServerClient()` which accesses cookies, making them inherently dynamic.

Do NOT add to routes that already have `export const runtime = 'edge'` or `export const runtime = 'nodejs'` - they're already configured.
  </action>
  <verify>pnpm build 2>&1 | grep -E "Dynamic server usage|couldn't be rendered statically" || echo "No dynamic server errors"</verify>
  <done>No "Dynamic server usage" errors during build</done>
</task>

<task type="auto">
  <name>Task 2: Wrap useSearchParams in Suspense boundaries</name>
  <files>
    app/app/(protected)/generate/page.tsx,
    app/app/(protected)/templates/page.tsx
  </files>
  <action>
Fix "useSearchParams() should be wrapped in a suspense boundary" errors.

For each page:
1. Create a new inner component that contains the current page logic (e.g., `GeneratePageContent`)
2. The inner component uses `useSearchParams()`
3. The default export wraps the inner component in `<Suspense fallback={...}>`

Pattern:
```tsx
import { Suspense } from 'react';

function PageContent() {
  const searchParams = useSearchParams();
  // ... rest of component logic
}

export default function Page() {
  return (
    <Suspense fallback={<div className="flex items-center justify-center min-h-screen"><span className="animate-pulse">Loading...</span></div>}>
      <PageContent />
    </Suspense>
  );
}
```

Keep the 'use client' directive at the top of the file.
  </action>
  <verify>pnpm build 2>&1 | grep -E "useSearchParams.*should be wrapped|missing-suspense" || echo "No Suspense errors"</verify>
  <done>No useSearchParams/Suspense errors during build</done>
</task>

<task type="auto">
  <name>Task 3: Run full build and verify zero errors</name>
  <files>None (verification only)</files>
  <action>
Run complete build to confirm all errors are fixed:
```bash
cd app && pnpm build
```

If any errors remain:
- "Dynamic server usage" → add `export const dynamic = 'force-dynamic'` to that route
- "useSearchParams" → wrap in Suspense
- TypeScript errors → fix the type issues

The build should complete successfully. Warnings are acceptable for this plan (addressed in 20-02).
  </action>
  <verify>cd app && pnpm build 2>&1 | tail -20</verify>
  <done>Build completes with "✓ Generating static pages" and no error exit code</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` completes without errors
- [ ] No "Dynamic server usage" errors
- [ ] No "useSearchParams should be wrapped in Suspense" errors
- [ ] Build output shows successful static page generation
</verification>

<success_criteria>

- All tasks completed
- Build passes with zero errors
- Warnings may exist (addressed in later plans)
- Application can be deployed to Vercel
  </success_criteria>

<output>
After completion, create `.planning/phases/20-vercel-deployment-readiness/20-01-SUMMARY.md`
</output>
