---
phase: 20-vercel-deployment-readiness
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - app/package.json
  - app/next.config.mjs
autonomous: true
must_haves:
  truths:
    - "Bundle analyzer can be run with npm script"
    - "Images use next/image for optimization"
    - "Build output shows reasonable bundle sizes"
  artifacts:
    - path: "app/package.json"
      provides: "Bundle analyze script"
      contains: "analyze"
    - path: "app/next.config.mjs"
      provides: "Conditional bundle analyzer"
      contains: "ANALYZE"
  key_links:
    - from: "package.json analyze script"
      to: "next.config.mjs"
      via: "ANALYZE environment variable"
      pattern: "ANALYZE"
---

<objective>
Set up bundle analyzer for optimization visibility and optimize image handling configuration.

Purpose: Enable bundle size analysis and ensure images are optimized for production.
Output: Working bundle analyzer setup and optimized next.config.mjs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STACK.md

Relevant source files:
@app/package.json
@app/next.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure bundle analyzer</name>
  <files>app/package.json, app/next.config.mjs</files>
  <action>
1. Install the bundle analyzer:
```bash
cd app && pnpm add -D @next/bundle-analyzer
```

2. Update `app/next.config.mjs` to conditionally enable analyzer:
```javascript
import bundleAnalyzer from '@next/bundle-analyzer';

const withBundleAnalyzer = bundleAnalyzer({
  enabled: process.env.ANALYZE === 'true',
});

/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  experimental: {
    serverActions: {
      allowedOrigins: ['localhost:3000'],
    },
  },
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.supabase.co',
      },
    ],
    // Optimize image formats for modern browsers
    formats: ['image/avif', 'image/webp'],
  },
  // Enable edge runtime for specific routes
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          { key: 'X-DNS-Prefetch-Control', value: 'on' },
          { key: 'X-XSS-Protection', value: '1; mode=block' },
          { key: 'X-Frame-Options', value: 'SAMEORIGIN' },
          { key: 'X-Content-Type-Options', value: 'nosniff' },
          { key: 'Referrer-Policy', value: 'origin-when-cross-origin' },
        ],
      },
    ];
  },
};

export default withBundleAnalyzer(nextConfig);
```

3. Add analyze script to `app/package.json`:
```json
{
  "scripts": {
    ...existing scripts...,
    "analyze": "ANALYZE=true pnpm build"
  }
}
```
  </action>
  <verify>cd app && pnpm analyze 2>&1 | head -30</verify>
  <done>Bundle analyzer opens in browser showing bundle composition</done>
</task>

<task type="auto">
  <name>Task 2: Review and optimize image configuration</name>
  <files>app/next.config.mjs</files>
  <action>
Verify image optimization is properly configured in next.config.mjs:

1. Ensure `images.formats` includes modern formats: `['image/avif', 'image/webp']`
2. The existing `remotePatterns` for Supabase is correct
3. If the landing page uses external images (like placeholder images), add their domains:

```javascript
images: {
  remotePatterns: [
    {
      protocol: 'https',
      hostname: '*.supabase.co',
    },
    // Add if using placeholder services
    {
      protocol: 'https',
      hostname: 'images.unsplash.com',
    },
  ],
  formats: ['image/avif', 'image/webp'],
  // Default device sizes are usually fine
  // deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
},
```

Note: The existing codebase has `<img>` tags in admin/institutions pages (noted in build warnings). Those are internal admin pages and low priority - the main user-facing pages use next/image properly.
  </action>
  <verify>grep -A 10 "images:" app/next.config.mjs</verify>
  <done>Image configuration includes modern formats (AVIF, WebP) and proper remote patterns</done>
</task>

<task type="auto">
  <name>Task 3: Run build and capture bundle metrics</name>
  <files>None (verification only)</files>
  <action>
Run a production build and capture the bundle size report:

```bash
cd app && pnpm build
```

Review the build output for:
1. Total First Load JS size (target: < 100kB shared, < 200kB per page)
2. Any unusually large chunks
3. Pages marked as "static" vs "dynamic"

The build output shows:
- λ (dynamic) routes that render server-side
- ○ (static) routes that are pre-rendered
- First Load JS sizes for each route

Document the current state for baseline comparison.

Acceptable thresholds:
- Shared chunks: < 120kB
- Individual pages: < 200kB first load
- Largest page (generate/templates): < 300kB acceptable due to rich UI
  </action>
  <verify>cd app && pnpm build 2>&1 | grep -A 50 "Route.*Size"</verify>
  <done>Build completes and shows bundle sizes within acceptable thresholds</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] @next/bundle-analyzer installed
- [ ] `pnpm analyze` script works and opens browser
- [ ] next.config.mjs has image optimization with modern formats
- [ ] Build output shows bundle sizes
</verification>

<success_criteria>

- All tasks completed
- Bundle analyzer functional
- Image optimization configured
- Bundle sizes within acceptable ranges
  </success_criteria>

<output>
After completion, create `.planning/phases/20-vercel-deployment-readiness/20-03-SUMMARY.md`
</output>
