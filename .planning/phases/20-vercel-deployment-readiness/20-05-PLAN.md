---
phase: 20-vercel-deployment-readiness
plan: 05
type: execute
wave: 3
depends_on: ["20-01", "20-02", "20-03", "20-04"]
files_modified:
  - app/app/layout.tsx
  - DEPLOYMENT.md
autonomous: false
must_haves:
  truths:
    - "Vercel Analytics configured for production monitoring"
    - "Deployment guide documents complete process"
    - "Production checklist covers all critical items"
  artifacts:
    - path: "app/app/layout.tsx"
      provides: "Vercel Analytics integration"
      contains: "@vercel/analytics"
    - path: "DEPLOYMENT.md"
      provides: "Complete deployment documentation"
      min_lines: 100
  key_links:
    - from: "DEPLOYMENT.md"
      to: "Vercel platform"
      via: "deployment instructions"
---

<objective>
Set up monitoring with Vercel Analytics and create comprehensive deployment documentation.

Purpose: Enable production visibility and provide deployment runbook.
Output: Working analytics and DEPLOYMENT.md guide.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Relevant source files:
@app/app/layout.tsx
@app/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Vercel Analytics</name>
  <files>app/package.json, app/app/layout.tsx</files>
  <action>
1. Install Vercel Analytics:
```bash
cd app && pnpm add @vercel/analytics
```

2. Add Analytics component to root layout (`app/app/layout.tsx`):

In the imports section, add:
```typescript
import { Analytics } from '@vercel/analytics/react';
```

In the RootLayout component, add the Analytics component just before the closing `</body>` tag:
```tsx
export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className={...}>
        <AuthProvider>
          <PreferencesProvider>
            <ToastProvider>
              {children}
            </ToastProvider>
          </PreferencesProvider>
        </AuthProvider>
        <Analytics />
      </body>
    </html>
  );
}
```

Note: Vercel Analytics is free tier with:
- Web Vitals (LCP, FID, CLS)
- Page views
- Basic visitor insights
- No additional configuration needed - auto-enabled on Vercel deployment
  </action>
  <verify>grep -A 3 "Analytics" app/app/layout.tsx</verify>
  <done>Vercel Analytics component added to root layout</done>
</task>

<task type="auto">
  <name>Task 2: Create deployment documentation</name>
  <files>DEPLOYMENT.md</files>
  <action>
Create `DEPLOYMENT.md` in the project root (not in app/) with comprehensive deployment guide:

```markdown
# AI Radiologist - Deployment Guide

## Overview

This guide covers deploying AI Radiologist to Vercel with Supabase backend.

## Prerequisites

- [ ] Vercel account (free or Pro)
- [ ] Supabase project (free or Pro)
- [ ] Stripe account with products configured
- [ ] OpenAI API key
- [ ] GitHub repository connected to Vercel

## Environment Setup

### Required Environment Variables

| Variable | Where to Get | Vercel Scope |
|----------|-------------|--------------|
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase Dashboard → Settings → API | All |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase Dashboard → Settings → API | All |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase Dashboard → Settings → API | All |
| `OPENAI_API_KEY` | OpenAI Platform → API Keys | All |
| `STRIPE_SECRET_KEY` | Stripe Dashboard → Developers → API keys | Production: live, Preview: test |
| `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` | Stripe Dashboard → Developers → API keys | Production: live, Preview: test |
| `STRIPE_WEBHOOK_SECRET` | Stripe Dashboard → Webhooks → Signing secret | Per environment |
| `STRIPE_PRICE_ID_PLUS` | Stripe Dashboard → Products | Per environment |
| `STRIPE_PRICE_ID_PRO` | Stripe Dashboard → Products | Per environment |
| `NEXT_PUBLIC_APP_URL` | Your domain | Production only |

### Environment Scoping

- **Development**: Use test API keys, local Supabase or dev project
- **Preview** (PR branches): Use test API keys, dev Supabase project
- **Production**: Use live API keys, production Supabase project

## Deployment Steps

### 1. First-Time Setup

1. **Import to Vercel**
   - Go to [vercel.com/new](https://vercel.com/new)
   - Import from GitHub
   - Select the repository
   - Framework: Next.js (auto-detected)
   - Root Directory: `app`

2. **Configure Build Settings**
   - Build Command: `pnpm build`
   - Output Directory: `.next`
   - Install Command: `pnpm install`

3. **Add Environment Variables**
   - Go to Project Settings → Environment Variables
   - Add each variable with appropriate scope
   - Mark sensitive vars as "Sensitive" (encrypted)

4. **Deploy**
   - Click Deploy
   - Wait for build to complete
   - Verify deployment URL works

### 2. Supabase Setup

1. **Database Migrations**
   ```bash
   # From app directory
   cd app

   # Link to your Supabase project
   npx supabase link --project-ref YOUR_PROJECT_REF

   # Push migrations
   npx supabase db push
   ```

2. **Configure Auth**
   - Supabase Dashboard → Authentication → URL Configuration
   - Site URL: `https://your-domain.com`
   - Redirect URLs: `https://your-domain.com/auth/callback`

3. **Enable RLS**
   - Verify RLS is enabled on all tables
   - Check policies in Supabase Dashboard → Database → Policies

### 3. Stripe Webhook Setup

1. **Create Webhook Endpoint**
   - Stripe Dashboard → Developers → Webhooks
   - Add endpoint: `https://your-domain.com/api/stripe/webhook`

2. **Select Events**
   - `checkout.session.completed`
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`

3. **Update Environment Variable**
   - Copy signing secret to `STRIPE_WEBHOOK_SECRET`
   - Add to Vercel Environment Variables (Production scope)

### 4. Domain Configuration

1. **Add Custom Domain**
   - Vercel Project → Settings → Domains
   - Add your domain
   - Configure DNS as instructed

2. **SSL Certificate**
   - Automatically provisioned by Vercel
   - Verify HTTPS works

## Verification Checklist

After deployment, verify:

- [ ] Homepage loads at custom domain
- [ ] Login/signup works
- [ ] Auth redirects work correctly
- [ ] Templates load from database
- [ ] AI report generation works
- [ ] Voice transcription works
- [ ] Stripe checkout opens
- [ ] Stripe webhook receives events (check Stripe Dashboard)
- [ ] PDF export works
- [ ] Admin pages accessible to admin users

## Monitoring

### Vercel Analytics

Automatically enabled. View at:
- Vercel Dashboard → Project → Analytics

Monitors:
- Core Web Vitals (LCP, FID, CLS)
- Page views
- Visitor insights

### Logs

View deployment logs:
- Vercel Dashboard → Project → Deployments → [deployment] → Functions

### Error Tracking

For production, consider adding:
- Sentry (recommended for detailed error tracking)
- LogRocket (for session replay)

## Rollback

If issues occur:

1. **Instant Rollback**
   - Vercel Dashboard → Deployments
   - Find last working deployment
   - Click "..." → "Promote to Production"

2. **Git-based Rollback**
   ```bash
   git revert HEAD
   git push
   ```

## Troubleshooting

### Build Failures

```bash
# Run build locally to see errors
cd app && pnpm build
```

### Environment Variable Issues

- Check variable names match exactly (case-sensitive)
- Verify `NEXT_PUBLIC_` prefix for client-side vars
- Check Vercel Dashboard → Settings → Environment Variables

### Database Connection Issues

- Verify Supabase project is active
- Check RLS policies
- Verify service role key has correct permissions

### Stripe Webhook Failures

- Check Stripe Dashboard → Developers → Webhooks → Events
- Verify webhook secret matches
- Check function logs in Vercel

## Security Reminders

- [ ] Never commit `.env.local` to git
- [ ] Use different Stripe keys for test vs production
- [ ] Rotate API keys periodically
- [ ] Review Supabase RLS policies before launch
- [ ] Enable 2FA on all service accounts

---

*Last updated: 2026-01-19*
```
  </action>
  <verify>wc -l DEPLOYMENT.md && head -50 DEPLOYMENT.md</verify>
  <done>DEPLOYMENT.md created with 100+ lines of comprehensive documentation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Vercel deployment readiness:
- Build errors fixed (Plan 01)
- Vercel configuration created (Plan 02)
- Bundle analyzer set up (Plan 03)
- Security headers configured (Plan 04)
- Vercel Analytics added (Plan 05)
- Deployment documentation created (Plan 05)
  </what-built>
  <how-to-verify>
1. Run the build:
   ```bash
   cd app && pnpm build
   ```
   Verify: Build completes with zero errors

2. Check the deployment docs:
   ```bash
   cat DEPLOYMENT.md
   ```
   Verify: Comprehensive guide covering all deployment steps

3. (Optional) If you have Vercel CLI installed:
   ```bash
   cd app && vercel --prod --dry-run
   ```
   Verify: No configuration errors

4. Review vercel.json:
   ```bash
   cat app/vercel.json
   ```
   Verify: Function timeouts configured properly
  </how-to-verify>
  <resume-signal>Type "approved" to complete the phase, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Vercel Analytics package installed
- [ ] Analytics component in root layout
- [ ] DEPLOYMENT.md comprehensive and accurate
- [ ] User verified deployment readiness
</verification>

<success_criteria>

- All tasks completed
- Vercel Analytics configured
- DEPLOYMENT.md provides complete deployment guide
- User approved final state
  </success_criteria>

<output>
After completion, create `.planning/phases/20-vercel-deployment-readiness/20-05-SUMMARY.md`
</output>
