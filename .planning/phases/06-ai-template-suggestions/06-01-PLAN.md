---
phase: 06-ai-template-suggestions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/app/api/templates/suggest/route.ts
  - app/app/(protected)/templates/[id]/page.tsx
  - app/app/(protected)/templates/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can request AI suggestions while creating or editing a template"
    - "Suggestions stream in real-time as GPT-4o generates them"
    - "User can apply suggested content to their template"
    - "Suggestions are contextual to the template's modality and body part"
  artifacts:
    - path: "app/app/api/templates/suggest/route.ts"
      provides: "GPT-4o streaming suggestions API endpoint"
      exports: ["POST"]
    - path: "app/app/(protected)/templates/[id]/page.tsx"
      provides: "Template edit page with AI suggestions"
      contains: "Get AI Suggestions"
    - path: "app/app/(protected)/templates/new/page.tsx"
      provides: "New template page with AI suggestions"
      contains: "Get AI Suggestions"
  key_links:
    - from: "templates/[id]/page.tsx"
      to: "/api/templates/suggest"
      via: "fetch with streaming ReadableStream"
      pattern: "fetch.*api/templates/suggest"
    - from: "templates/new/page.tsx"
      to: "/api/templates/suggest"
      via: "fetch with streaming ReadableStream"
      pattern: "fetch.*api/templates/suggest"
    - from: "api/templates/suggest/route.ts"
      to: "GPT-4o"
      via: "streamText from Vercel AI SDK"
      pattern: "streamText.*openai"
---

<objective>
Implement AI-assisted template suggestions using GPT-4o with streaming.

Purpose: Help radiologists create better templates by providing AI-generated suggestions for sections, content, and improvements based on the template's modality and body part.

Output: A working `/api/templates/suggest` endpoint and integrated UI in template create/edit pages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase patterns to follow:
@.planning/phases/04-ai-report-generation/04-01-SUMMARY.md

# Source files to modify:
@app/app/api/generate/route.ts
@app/app/(protected)/templates/[id]/page.tsx
@app/app/(protected)/templates/new/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template suggestion API endpoint</name>
  <files>app/app/api/templates/suggest/route.ts</files>
  <action>
Create an Edge runtime API endpoint that streams GPT-4o suggestions for templates.

Follow the exact pattern from `/api/generate/route.ts`:
- `export const runtime = 'edge'`
- `export const maxDuration = 30` (30 seconds timeout)
- Use `createServerClient` from `@supabase/ssr` with the same cookie handling pattern
- Authenticate user via Supabase (same pattern as generate)
- Validate request with Zod schema

Request body schema:
```typescript
const suggestRequestSchema = z.object({
  modality: z.string().min(1, 'Modality is required'),
  bodyPart: z.string().min(1, 'Body part is required'),
  description: z.string().optional(),
  existingSections: z.array(z.object({
    name: z.string(),
    content: z.string(),
  })).optional(),
  requestType: z.enum(['sections', 'improvements', 'normalFindings']),
});
```

For `requestType`:
- `sections`: Suggest new sections for a template (for new templates with few/no sections)
- `improvements`: Suggest improvements to existing sections (for edit mode)
- `normalFindings`: Suggest standard normal findings text for the modality/body part

System prompt should:
- Identify as a radiology template expert
- Be specific to the modality and body part
- For `sections`: suggest 3-5 standard sections with brief content
- For `improvements`: analyze existing sections and suggest enhancements
- For `normalFindings`: provide standard normal findings text

Use `streamText` from 'ai' with `openai('gpt-4o')`, temperature 0.3 (slightly higher than reports for creativity).
Return `result.toTextStreamResponse()`.
  </action>
  <verify>
curl -X POST http://localhost:3000/api/templates/suggest \
  -H "Content-Type: application/json" \
  -H "Cookie: [auth-cookie]" \
  -d '{"modality":"CT","bodyPart":"Chest","requestType":"sections"}' \
  --no-buffer

Should stream GPT-4o suggestions.
  </verify>
  <done>
- POST /api/templates/suggest returns 200 and streams suggestions
- Returns 401 for unauthenticated requests
- Returns 400 for invalid request body
- Returns 500 if OPENAI_API_KEY not configured
  </done>
</task>

<task type="auto">
  <name>Task 2: Add AI suggestions UI to template pages</name>
  <files>app/app/(protected)/templates/[id]/page.tsx, app/app/(protected)/templates/new/page.tsx</files>
  <action>
Add AI suggestions functionality to both template editor pages.

**For both pages, add:**

1. State for suggestions:
```typescript
const [isLoadingSuggestions, setIsLoadingSuggestions] = useState(false);
const [suggestions, setSuggestions] = useState('');
const [showSuggestions, setShowSuggestions] = useState(false);
const suggestionsAbortRef = useRef<AbortController | null>(null);
```

2. Function to fetch suggestions with streaming (same pattern as generate page):
```typescript
const handleGetSuggestions = async (requestType: 'sections' | 'improvements' | 'normalFindings') => {
  // Abort any existing request
  if (suggestionsAbortRef.current) {
    suggestionsAbortRef.current.abort();
  }

  const abortController = new AbortController();
  suggestionsAbortRef.current = abortController;

  setIsLoadingSuggestions(true);
  setSuggestions('');
  setShowSuggestions(true);

  try {
    const response = await fetch('/api/templates/suggest', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        modality: formData.modality,
        bodyPart: formData.bodyPart,
        description: formData.description,
        existingSections: sections || editSections,
        requestType,
      }),
      signal: abortController.signal,
    });

    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.message || 'Failed to get suggestions');
    }

    // Stream the response (same pattern as generate page)
    const reader = response.body?.getReader();
    const decoder = new TextDecoder();

    while (reader) {
      const { done, value } = await reader.read();
      if (done) break;
      const text = decoder.decode(value, { stream: true });
      setSuggestions(prev => prev + text);
    }
  } catch (error) {
    if ((error as Error).name !== 'AbortError') {
      showToast(error instanceof Error ? error.message : 'Failed to get suggestions', 'error');
    }
  } finally {
    setIsLoadingSuggestions(false);
  }
};
```

3. UI Components:

**In the Sections tab (edit page) or after sections list (new page):**
Add a button group for suggestion types:
```jsx
<div className="flex items-center gap-2 mt-4">
  <Button
    type="button"
    variant="outline"
    size="sm"
    onClick={() => handleGetSuggestions('sections')}
    disabled={isLoadingSuggestions || !formData.modality || !formData.bodyPart}
    data-testid="suggest-sections-btn"
  >
    {isLoadingSuggestions ? 'Getting Suggestions...' : 'âœ¨ Suggest Sections'}
  </Button>
  <Button
    type="button"
    variant="outline"
    size="sm"
    onClick={() => handleGetSuggestions('improvements')}
    disabled={isLoadingSuggestions || !formData.modality || !formData.bodyPart || (editSections || sections).length === 0}
    data-testid="suggest-improvements-btn"
  >
    âœ¨ Suggest Improvements
  </Button>
</div>
```

**In the Normal Findings tab (edit page only):**
Add a button:
```jsx
<Button
  type="button"
  variant="outline"
  size="sm"
  onClick={() => handleGetSuggestions('normalFindings')}
  disabled={isLoadingSuggestions || !formData.modality || !formData.bodyPart}
  data-testid="suggest-normal-findings-btn"
>
  {isLoadingSuggestions ? 'Getting Suggestions...' : 'âœ¨ Suggest Normal Findings'}
</Button>
```

**Suggestions display panel (add below the button groups):**
```jsx
{showSuggestions && (
  <div className="mt-4 p-4 rounded-lg border border-brand/30 bg-brand/5" data-testid="suggestions-panel">
    <div className="flex items-center justify-between mb-2">
      <h4 className="text-sm font-medium text-text-primary">AI Suggestions</h4>
      <Button
        type="button"
        variant="ghost"
        size="sm"
        onClick={() => {
          setShowSuggestions(false);
          setSuggestions('');
          if (suggestionsAbortRef.current) {
            suggestionsAbortRef.current.abort();
          }
        }}
        data-testid="close-suggestions-btn"
      >
        Close
      </Button>
    </div>
    <div className="prose prose-sm max-w-none">
      <pre className="whitespace-pre-wrap font-mono text-sm text-text-secondary bg-surface-muted p-3 rounded">
        {suggestions || 'Generating suggestions...'}
      </pre>
    </div>
    {!isLoadingSuggestions && suggestions && (
      <p className="mt-2 text-xs text-text-muted">
        ðŸ’¡ Copy relevant suggestions and paste into your template sections above.
      </p>
    )}
  </div>
)}
```

**Important implementation notes:**
- Import useRef from react
- Buttons should be disabled when modality or bodyPart are not selected (suggestions need context)
- "Suggest Improvements" only enabled when there are existing sections
- Use the same streaming pattern as the generate page (ReadableStream reader)
- Show loading state while streaming
- Allow user to close/dismiss suggestions panel
  </action>
  <verify>
1. npm run dev
2. Navigate to /templates/new
3. Select a modality and body part
4. Click "Suggest Sections" â€” should stream suggestions
5. Navigate to /templates/[id] for an existing template
6. Click Edit, go to Sections tab
7. Click "Suggest Improvements" â€” should stream contextual suggestions
8. Go to Normal Findings tab, click "Suggest Normal Findings" â€” should stream standard findings
  </verify>
  <done>
- "Suggest Sections" button appears on new template page
- "Suggest Sections" and "Suggest Improvements" buttons appear on edit template page
- "Suggest Normal Findings" button appears on Normal Findings tab
- Clicking any suggestion button streams AI suggestions
- Suggestions panel can be closed
- Buttons are disabled when required context (modality/bodyPart) is missing
- npm run build succeeds without errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] POST /api/templates/suggest streams GPT-4o suggestions
- [ ] New template page has working "Suggest Sections" button
- [ ] Edit template page has working "Suggest Sections" and "Suggest Improvements" buttons
- [ ] Normal Findings tab has working "Suggest Normal Findings" button
- [ ] Suggestions stream in real-time (same UX as report generation)
- [ ] Unauthenticated requests return 401
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- TMPL-07 requirement satisfied: User can get AI-assisted suggestions for template creation/improvement
- Suggestions are relevant to radiology domain (modality/body part context)
  </success_criteria>

<output>
After completion, create `.planning/phases/06-ai-template-suggestions/06-01-SUMMARY.md`
</output>
