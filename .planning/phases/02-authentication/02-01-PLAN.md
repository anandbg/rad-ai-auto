---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/tests/e2e/auth.spec.ts
  - app/app/api/auth/callback/route.ts
autonomous: true

must_haves:
  truths:
    - "User can create account with email and password"
    - "User receives verification email after signup"
    - "User can log in with valid credentials and reach dashboard"
    - "User session persists across browser refresh"
    - "User can request password reset and receives email"
    - "User can reset password via email link"
  artifacts:
    - path: "app/app/signup/page.tsx"
      provides: "Signup form with Supabase signUp"
      contains: "supabase.auth.signUp"
    - path: "app/app/login/page.tsx"
      provides: "Login form with Supabase signInWithPassword"
      contains: "supabase.auth.signInWithPassword"
    - path: "app/app/forgot-password/page.tsx"
      provides: "Password reset request form"
      contains: "supabase.auth.resetPasswordForEmail"
    - path: "app/app/reset-password/page.tsx"
      provides: "Password update form"
      contains: "supabase.auth.updateUser"
    - path: "app/app/api/auth/callback/route.ts"
      provides: "Supabase auth callback handler"
      exports: ["GET"]
    - path: "app/lib/auth/auth-context.tsx"
      provides: "Auth context with real Supabase"
      contains: "supabase.auth.getUser"
    - path: "app/middleware.ts"
      provides: "Route protection and session refresh"
      contains: "updateSession"
  key_links:
    - from: "app/app/signup/page.tsx"
      to: "Supabase Auth"
      via: "supabase.auth.signUp"
      pattern: "signUp\\(\\{"
    - from: "app/app/login/page.tsx"
      to: "Supabase Auth"
      via: "supabase.auth.signInWithPassword"
      pattern: "signInWithPassword\\(\\{"
    - from: "app/middleware.ts"
      to: "Protected routes"
      via: "session check and redirect"
      pattern: "isProtectedRoute && !user"
---

<objective>
Verify and finalize Supabase authentication implementation.

Purpose: The auth implementation exists but needs verification that all flows work end-to-end with the real Supabase project. This phase ensures signup, email verification, login, session persistence, and password reset all function correctly.

Output: Verified auth system with updated E2E tests reflecting actual implementation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation/01-01-SUMMARY.md

# Existing auth implementation
@app/lib/auth/auth-context.tsx
@app/lib/supabase/client.ts
@app/lib/supabase/server.ts
@app/lib/supabase/middleware.ts
@app/middleware.ts
@app/app/login/page.tsx
@app/app/signup/page.tsx
@app/app/forgot-password/page.tsx
@app/app/reset-password/page.tsx
@app/app/verify-email/page.tsx

# Existing tests
@app/tests/e2e/auth.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase auth callback route</name>
  <files>app/app/api/auth/callback/route.ts</files>
  <action>
Create the auth callback route handler that Supabase uses for email confirmation and OAuth redirects. This route:
1. Receives the `code` query parameter from Supabase email links
2. Exchanges the code for a session using `supabase.auth.exchangeCodeForSession(code)`
3. Redirects to the appropriate page based on the `next` query param or defaults to `/dashboard`

Use the server Supabase client pattern from `@/lib/supabase/server.ts`.

The route must handle:
- Email verification callback (after signup confirmation)
- Password reset callback (before showing reset form)
- Error cases (missing code, invalid code)

Reference Supabase SSR auth docs pattern:
```typescript
import { createSupabaseServerClient } from '@/lib/supabase/server';
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  const { searchParams, origin } = new URL(request.url);
  const code = searchParams.get('code');
  const next = searchParams.get('next') ?? '/dashboard';

  if (code) {
    const supabase = await createSupabaseServerClient();
    const { error } = await supabase.auth.exchangeCodeForSession(code);
    if (!error) {
      return NextResponse.redirect(`${origin}${next}`);
    }
  }

  // Return to error page on failure
  return NextResponse.redirect(`${origin}/login?error=auth_callback_error`);
}
```
  </action>
  <verify>
File exists at `app/app/api/auth/callback/route.ts` with GET handler that exchanges code for session
  </verify>
  <done>
Auth callback route handles email verification and password reset redirects from Supabase
  </done>
</task>

<task type="auto">
  <name>Task 2: Update E2E auth tests to match implementation</name>
  <files>app/tests/e2e/auth.spec.ts</files>
  <action>
Update the E2E auth tests to reflect the actual implementation:

1. **Remove E2E-005 (Google OAuth)**: Google OAuth is explicitly out of scope for v1 (see PROJECT.md). Remove this test entirely.

2. **Fix E2E-003 (validation errors)**: The login form uses HTML5 `required` attribute, not custom JavaScript validation that shows text like "email required". The browser handles validation natively. Change this test to:
   - Submit form with invalid email format
   - Verify Supabase returns error (or browser validation triggers)

3. **Add E2E-006 (signup form validation)**: The signup form has proper Zod validation with error messages. Add a test that:
   - Fills in mismatched passwords
   - Verifies "Passwords must match" error appears

4. **Add E2E-007 (forgot password page)**: Test that forgot password form is accessible:
   - Navigate to /forgot-password
   - Verify form elements present
   - Verify "Back to Login" link works

5. **Update test IDs and descriptions** to accurately describe what they test.

Keep tests focused on UI presence and navigation - don't test actual auth flows which require real accounts.
  </action>
  <verify>
Run `pnpm exec playwright test tests/e2e/auth.spec.ts --reporter=list` (or check file compiles without the Google OAuth test)
  </verify>
  <done>
E2E tests accurately reflect the implemented auth UI without Google OAuth
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify auth flow configuration</name>
  <files>app/app/forgot-password/page.tsx</files>
  <action>
Verify the forgot-password page has the correct redirect URL configuration for Supabase password reset emails.

Check that `redirectTo` in `resetPasswordForEmail` points to the auth callback route:
```typescript
const { error: resetError } = await supabase.auth.resetPasswordForEmail(email, {
  redirectTo: `${window.location.origin}/api/auth/callback?next=/reset-password`,
});
```

The current implementation uses `/reset-password` directly, but Supabase needs to go through the callback to exchange the code first. Update if needed.

Also verify signup flow:
- Check that `supabase.auth.signUp` has proper `emailRedirectTo` in options pointing to `/api/auth/callback?next=/verify-email` for email confirmation

Note: If the current implementation works (Supabase may handle this automatically for some flows), document the finding but don't change working code.
  </action>
  <verify>
Read the forgot-password and signup pages, verify redirect URLs are correct or document why current approach works
  </verify>
  <done>
Auth flow redirect URLs verified and corrected if needed
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Auth callback route exists and handles code exchange
- [ ] E2E tests compile without Google OAuth test
- [ ] All auth pages load without errors
- [ ] No TypeScript errors introduced
</verification>

<success_criteria>

- Auth callback route created at `/api/auth/callback`
- E2E tests updated to match actual implementation
- Redirect URLs verified for email flows
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
