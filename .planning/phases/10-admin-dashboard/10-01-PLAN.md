---
phase: 10-admin-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/app/api/admin/stats/route.ts
  - app/app/(protected)/admin/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view list of all users with roles and plans"
    - "Admin can publish and unpublish global templates"
    - "Admin can view system-wide usage statistics"
  artifacts:
    - path: "app/app/api/admin/stats/route.ts"
      provides: "System-wide analytics API endpoint"
      exports: ["GET"]
    - path: "app/app/(protected)/admin/page.tsx"
      provides: "Admin dashboard with statistics display"
      min_lines: 100
  key_links:
    - from: "admin/page.tsx"
      to: "/api/admin/stats"
      via: "fetch in useEffect"
      pattern: "fetch.*api/admin/stats"
    - from: "/api/admin/stats"
      to: "supabase"
      via: "aggregate queries on report_sessions, transcribe_sessions, credits_ledger"
      pattern: "supabase\\.from\\("
---

<objective>
Connect admin dashboard features to real database for user management, template publishing, and analytics.

Purpose: Enable administrators to manage the platform - view users, control global templates, and monitor usage.
Output: Fully functional admin dashboard connected to Supabase with real-time statistics.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# Existing admin infrastructure:
@app/app/api/admin/users/route.ts
@app/app/(protected)/admin/page.tsx
@app/app/(protected)/admin/users/page.tsx
@app/app/(protected)/admin/templates/page.tsx

# Database schema (admin has access to these tables via is_admin() RLS):
@app/supabase/migrations/20260116010000_initial_schema.sql
@app/supabase/migrations/20260116020000_rls_policies.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin statistics API endpoint</name>
  <files>app/app/api/admin/stats/route.ts</files>
  <action>
Create GET endpoint that aggregates system-wide statistics for the admin dashboard.

**Authentication:** Same pattern as /api/admin/users - check user auth, verify admin role via profiles table.

**Statistics to aggregate:**
1. **User stats:**
   - Total users (count profiles)
   - Users by role (count where role = 'admin' vs 'radiologist')
   - New users this month (count where created_at > start of month)

2. **Usage stats:**
   - Total reports generated (count report_sessions)
   - Reports this month (count where created_at > start of month)
   - Total transcriptions (count transcribe_sessions where status = 'completed')
   - Transcriptions this month

3. **Subscription stats:**
   - Users by plan (count subscriptions grouped by plan)
   - Active subscriptions (count where status = 'active')

4. **Template stats:**
   - Global templates count (published vs draft)
   - Personal templates count (total across all users)

**Response format:**
```json
{
  "success": true,
  "data": {
    "users": { "total": 100, "admins": 3, "radiologists": 97, "newThisMonth": 12 },
    "usage": { "totalReports": 1234, "reportsThisMonth": 89, "totalTranscriptions": 567, "transcriptionsThisMonth": 45 },
    "subscriptions": { "free": 50, "plus": 30, "pro": 20, "activeCount": 95 },
    "templates": { "globalPublished": 15, "globalDraft": 5, "personalTotal": 234 }
  }
}
```

**Implementation notes:**
- Use Supabase server client from @/lib/supabase/server
- Use aggregate queries with count() where possible
- For monthly stats, calculate start of current month in UTC
- Follow existing error handling pattern from /api/admin/users
  </action>
  <verify>
curl -X GET http://localhost:3000/api/admin/stats returns JSON with stats structure (requires valid admin session)
  </verify>
  <done>
API endpoint returns aggregated statistics when called by admin user, 403 for non-admins, 401 for unauthenticated
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire admin dashboard to statistics API</name>
  <files>app/app/(protected)/admin/page.tsx</files>
  <action>
Update the admin dashboard page to display real statistics from the new API.

**Changes:**
1. Add state for stats: `const [stats, setStats] = useState<AdminStats | null>(null)`
2. Add loading state: `const [statsLoading, setStatsLoading] = useState(true)`
3. Add useEffect to fetch stats on mount from `/api/admin/stats`
4. Replace "Coming Soon" on "System Statistics" card with actual stats display

**Stats display (replace the disabled System Statistics card):**
- Grid of 4 stat cards showing:
  - Total Users (with new this month as subtitle)
  - Total Reports Generated (with this month as subtitle)
  - Total Transcriptions (with this month as subtitle)
  - Active Subscriptions (with breakdown by plan)

**UI considerations:**
- Show loading spinner while fetching
- Show error message if fetch fails
- Use existing Card components for consistency
- Match styling of existing stat cards on /admin/users page

**Do NOT:**
- Remove existing links to users/templates/institutions
- Change the overall page layout structure
- Add any new navigation items
  </action>
  <verify>
npm run dev, navigate to /admin as admin user, verify statistics cards display real numbers instead of "Coming Soon"
  </verify>
  <done>
Admin dashboard displays real-time statistics from database, loading state shows while fetching, error handled gracefully
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Admin can access /admin/stats API (returns 200 with stats)
- [ ] Non-admin gets 403 from /admin/stats API
- [ ] Admin dashboard displays real statistics
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- ADMIN-01 satisfied (user list already works, verified in existing code)
- ADMIN-02 satisfied (template publish/unpublish already works via Supabase browser client)
- ADMIN-03 satisfied (new stats API and dashboard display)
</success_criteria>

<output>
After completion, create `.planning/phases/10-admin-dashboard/10-01-SUMMARY.md`
</output>
