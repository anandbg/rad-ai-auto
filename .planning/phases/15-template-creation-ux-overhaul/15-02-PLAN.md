---
phase: 15-template-creation-ux-overhaul
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/app/api/templates/generate/route.ts
  - app/lib/validation/template-schema.ts
autonomous: true

must_haves:
  truths:
    - "AI-generated templates always conform to Zod schema"
    - "User description is transformed into structured sections"
    - "Generated templates never fail validation on save"
  artifacts:
    - path: "app/app/api/templates/generate/route.ts"
      provides: "AI template generation with structured output"
      exports: ["POST"]
      min_lines: 50
    - path: "app/lib/validation/template-schema.ts"
      provides: "Extended schema with AI descriptions"
      contains: "aiGeneratedTemplateSchema"
  key_links:
    - from: "route.ts"
      to: "template-schema.ts"
      via: "Output.object with schema"
      pattern: "Output\\.object.*aiGeneratedTemplateSchema"
---

<objective>
Create AI template generation endpoint using Vercel AI SDK structured outputs.

Purpose: Enable AI to generate valid, schema-compliant templates from freeform descriptions.
Output: POST /api/templates/generate endpoint that returns structured template data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research findings for AI SDK structured output
@.planning/phases/15-template-creation-ux-overhaul/15-RESEARCH.md

# Existing template schema
@app/lib/validation/template-schema.ts

# Existing AI suggest endpoint (reference pattern)
@app/app/api/templates/suggest/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend template schema with AI generation descriptions</name>
  <files>app/lib/validation/template-schema.ts</files>
  <action>
    Add a new schema for AI-generated templates that includes Zod .describe() annotations.
    The AI SDK uses these descriptions to guide the LLM output.

    Add to existing file:
    ```typescript
    // Schema for AI template generation with descriptions for LLM guidance
    export const aiGeneratedTemplateSchema = z.object({
      name: z.string()
        .min(3)
        .max(100)
        .describe('Template name based on modality and body part, e.g., "CT Chest with Contrast Protocol"'),
      modality: z.string()
        .describe('Imaging modality: X-Ray, CT, MRI, Ultrasound, PET, Mammography, Fluoroscopy, Nuclear Medicine, or Other'),
      bodyPart: z.string()
        .describe('Body region: Head, Neck, Chest, Abdomen, Pelvis, Spine, Upper Extremity, Lower Extremity, Whole Body, or Other'),
      description: z.string()
        .min(10)
        .max(500)
        .describe('When to use this template - clinical indications and scenarios'),
      sections: z.array(z.object({
        id: z.string().describe('Unique identifier, use format "section-1", "section-2", etc.'),
        name: z.string().describe('Section name in ALL CAPS, e.g., TECHNIQUE, COMPARISON, FINDINGS, IMPRESSION'),
        content: z.string().describe('Template content with [placeholders] for variable data and (instructions) for conditional guidance. Use radiology-specific language.')
      }))
        .min(3)
        .max(8)
        .describe('Ordered list of report sections. Include at minimum: TECHNIQUE, FINDINGS, IMPRESSION')
    });

    export type AIGeneratedTemplate = z.infer<typeof aiGeneratedTemplateSchema>;
    ```

    Do NOT modify the existing templateFormSchema - keep it for form validation.
  </action>
  <verify>cd app && npx tsc --noEmit passes</verify>
  <done>aiGeneratedTemplateSchema exported with .describe() annotations</done>
</task>

<task type="auto">
  <name>Task 2: Create AI template generation endpoint</name>
  <files>app/app/api/templates/generate/route.ts</files>
  <action>
    Create new API route at app/app/api/templates/generate/route.ts.

    Requirements:
    1. Import generateText and Output from 'ai' package
    2. Import openai from '@ai-sdk/openai'
    3. Import aiGeneratedTemplateSchema from @/lib/validation/template-schema
    4. Import createSupabaseServerClient for auth check
    5. Accept POST with JSON body: { description: string, modality?: string, bodyPart?: string }
    6. Require authentication (return 401 if no user)
    7. Use generateText with Output.object({ schema: aiGeneratedTemplateSchema })
    8. Use temperature 0.3 for deterministic output
    9. Return { success: true, data: output }

    System prompt guidance:
    ```
    You are a radiology report template expert. Create structured templates for radiologists.

    Template syntax rules:
    - Use [placeholder] for variable data, e.g., [patient age], [laterality]
    - Use (instructions) for conditional guidance, e.g., (describe if abnormal)
    - Use "verbatim text" for exact phrases to include
    - Section names should be ALL CAPS: TECHNIQUE, COMPARISON, FINDINGS, IMPRESSION
    - Include standard sections for the modality
    - Be specific to the body part and clinical context
    ```

    User prompt:
    ```
    Create a radiology report template for ${modality || 'the specified'} imaging of ${bodyPart || 'the specified body part'}.

    User requirements: ${description}

    Generate a professional template with appropriate sections for this exam type.
    ```

    Error handling: Return 400 for missing description, 500 for AI errors with message.
  </action>
  <verify>cd app && npx tsc --noEmit passes</verify>
  <done>POST /api/templates/generate returns schema-validated template</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd app && npx tsc --noEmit` passes
- [ ] aiGeneratedTemplateSchema exported from template-schema.ts
- [ ] route.ts uses Output.object with the schema
- [ ] route.ts requires authentication
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- AI generation uses structured output guaranteeing schema compliance
- Endpoint requires auth and validates input
</success_criteria>

<output>
After completion, create `.planning/phases/15-template-creation-ux-overhaul/15-02-SUMMARY.md`
</output>
