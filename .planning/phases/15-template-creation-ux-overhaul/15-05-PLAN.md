---
phase: 15-template-creation-ux-overhaul
plan: 05
type: execute
wave: 3
depends_on: ["15-02", "15-04"]
files_modified:
  - app/app/(protected)/templates/new/page.tsx
  - app/components/template-builder/ai-generation-dialog.tsx
autonomous: false

must_haves:
  truths:
    - "User can describe template and receive AI-generated sections"
    - "AI-generated template appears in editor for customization"
    - "All 4 creation pathways work end-to-end"
    - "Clone pathway navigates to template list"
  artifacts:
    - path: "app/components/template-builder/ai-generation-dialog.tsx"
      provides: "Dialog for entering AI template description"
      exports: ["AIGenerationDialog"]
      min_lines: 60
  key_links:
    - from: "ai-generation-dialog.tsx"
      to: "/api/templates/generate"
      via: "fetch POST with description"
      pattern: "fetch.*api/templates/generate"
    - from: "new/page.tsx"
      to: "ai-generation-dialog.tsx"
      via: "shows dialog when AI pathway selected"
      pattern: "AIGenerationDialog"
---

<objective>
Wire AI generation pathway and verify all creation flows work end-to-end.

Purpose: Complete the AI-assisted template creation experience.
Output: Working AI generation flow with checkpoint verification of all pathways.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summaries
@.planning/phases/15-template-creation-ux-overhaul/15-02-SUMMARY.md
@.planning/phases/15-template-creation-ux-overhaul/15-04-SUMMARY.md

# Template page to enhance
@app/app/(protected)/templates/new/page.tsx

# AI generation endpoint
@app/app/api/templates/generate/route.ts

# Template schema
@app/lib/validation/template-schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AIGenerationDialog component</name>
  <files>app/components/template-builder/ai-generation-dialog.tsx</files>
  <action>
    Create new file app/components/template-builder/ai-generation-dialog.tsx.

    Component requirements:
    1. Accept props: { open, onOpenChange, onGenerated, initialModality?, initialBodyPart? }
    2. Use Dialog from @/components/ui/dialog
    3. Form fields:
       - Textarea for freeform description (required, placeholder: "Describe your template...")
       - Optional modality select (pre-filled if provided)
       - Optional body part select (pre-filled if provided)
    4. Submit button: "Generate Template" with loading state
    5. On submit:
       - Call POST /api/templates/generate with { description, modality, bodyPart }
       - Show loading spinner during generation
       - On success: call onGenerated(data) and close dialog
       - On error: show toast with error message
    6. Include cancel button

    Use existing select styling from templates/new/page.tsx for modality/bodyPart dropdowns.

    Example onGenerated callback will populate the form with AI-generated data:
    ```tsx
    const handleGenerated = (data: AIGeneratedTemplate) => {
      setFormData({
        name: data.name,
        modality: data.modality,
        bodyPart: data.bodyPart,
        description: data.description,
        content: '',
      });
      setSections(data.sections);
    };
    ```

    Export AIGenerationDialog as named export.
  </action>
  <verify>cd app && npx tsc --noEmit passes</verify>
  <done>AIGenerationDialog renders form and calls generate endpoint</done>
</task>

<task type="auto">
  <name>Task 2: Wire AI pathway in template creation page</name>
  <files>app/app/(protected)/templates/new/page.tsx</files>
  <action>
    Update the template creation page to handle AI pathway:

    1. Import { AIGenerationDialog } from '@/components/template-builder/ai-generation-dialog'
    2. Import { AIGeneratedTemplate } from '@/lib/validation/template-schema'
    3. Add state: const [showAIDialog, setShowAIDialog] = useState(false)

    Update handlePathwaySelect:
    ```tsx
    const handlePathwaySelect = (pathway: PathwayType) => {
      setSelectedPathway(pathway);
      setShowPathwayModal(false);

      switch (pathway) {
        case 'ai':
          setShowAIDialog(true);
          break;
        case 'import':
          fileInputRef.current?.click();
          break;
        case 'clone':
          // Navigate to templates list with clone mode
          router.push('/templates?action=clone');
          break;
        case 'manual':
          // Default, just close modal
          break;
      }
    };
    ```

    Add AI generation handler:
    ```tsx
    const handleAIGenerated = (data: AIGeneratedTemplate) => {
      setFormData({
        name: data.name,
        modality: data.modality,
        bodyPart: data.bodyPart,
        description: data.description,
        content: '',
      });
      setSections(data.sections);
      showToast('Template generated! Review and customize below.', 'success');
    };
    ```

    Add dialog render after CreationPathwayModal:
    ```tsx
    <AIGenerationDialog
      open={showAIDialog}
      onOpenChange={setShowAIDialog}
      onGenerated={handleAIGenerated}
      initialModality={formData.modality}
      initialBodyPart={formData.bodyPart}
    />
    ```
  </action>
  <verify>cd app && npx tsc --noEmit passes</verify>
  <done>AI pathway opens dialog, generated template populates form</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete template creation experience with 4 pathways: Manual, AI-Assisted, Clone, Import</what-built>
  <how-to-verify>
    1. Run: cd app && pnpm dev
    2. Navigate to http://localhost:3000/templates/new
    3. Pathway modal should appear on load

    Test Manual pathway:
    4. Select "Start from scratch"
    5. Modal closes, form is empty
    6. Add a section, verify drag handle appears
    7. Add second section, drag to reorder - verify sections swap positions
    8. Verify preview panel shows sections in real-time
    9. Resize the split pane - verify both panels resize

    Test AI-Assisted pathway:
    10. Click "Change Creation Method" button
    11. Select "Describe your template"
    12. Enter: "CT chest with contrast for pulmonary embolism workup"
    13. Click "Generate Template"
    14. Verify loading state shows
    15. After generation: form should populate with name, modality, body part, description
    16. Sections should appear with AI-generated content
    17. Verify you can edit the generated sections

    Test Import pathway:
    18. Create a test file ~/test-template.json with valid template JSON
    19. Click "Change Creation Method" > "Import JSON"
    20. Select the test file
    21. Verify form populates with imported data

    Test Clone pathway:
    22. Click "Change Creation Method" > "Start from existing"
    23. Verify navigation to /templates?action=clone

    Verify preview:
    24. Edit a section content with [placeholder] text
    25. Verify preview highlights placeholder with brand color

  </how-to-verify>
  <resume-signal>Type "approved" if all pathways work, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before checkpoint:
- [ ] `cd app && npx tsc --noEmit` passes
- [ ] `cd app && pnpm build` succeeds
- [ ] AIGenerationDialog component exists
- [ ] AI pathway triggers dialog
- [ ] Clone pathway navigates to templates list
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified all 4 pathways work
- Drag-drop reordering functional
- Live preview updates correctly
</success_criteria>

<output>
After completion, create `.planning/phases/15-template-creation-ux-overhaul/15-05-SUMMARY.md`
</output>
