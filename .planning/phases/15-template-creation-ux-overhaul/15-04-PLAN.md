---
phase: 15-template-creation-ux-overhaul
plan: 04
type: execute
wave: 2
depends_on: ["15-01", "15-03"]
files_modified:
  - app/app/(protected)/templates/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "Template editor shows split pane with editor on left, preview on right"
    - "User can resize the split pane"
    - "Sections can be dragged to reorder"
    - "User can import template from JSON file"
    - "Preview updates in real-time as user edits"
  artifacts:
    - path: "app/app/(protected)/templates/new/page.tsx"
      provides: "Enhanced template builder with split pane, dnd, pathways"
      contains: "PanelGroup"
      min_lines: 400
  key_links:
    - from: "new/page.tsx"
      to: "section-list.tsx"
      via: "renders SectionList for sections"
      pattern: "SectionList"
    - from: "new/page.tsx"
      to: "template-preview.tsx"
      via: "renders TemplatePreview in right panel"
      pattern: "TemplatePreview"
    - from: "new/page.tsx"
      to: "creation-pathway-modal.tsx"
      via: "shows modal on mount or button click"
      pattern: "CreationPathwayModal"
---

<objective>
Integrate split-pane layout, drag-drop sections, and import pathway into template creation page.

Purpose: Transform basic form into full-featured template builder with live preview.
Output: Enhanced new template page with resizable split pane, sortable sections, and import capability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summaries (uses components from 15-01, 15-03)
@.planning/phases/15-template-creation-ux-overhaul/15-01-SUMMARY.md
@.planning/phases/15-template-creation-ux-overhaul/15-03-SUMMARY.md

# Existing template creation page to enhance
@app/app/(protected)/templates/new/page.tsx

# Components to integrate
@app/components/template-builder/section-list.tsx
@app/components/template-builder/template-preview.tsx
@app/components/template-builder/creation-pathway-modal.tsx

# Template schema for validation
@app/lib/validation/template-schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add split-pane layout with react-resizable-panels</name>
  <files>app/app/(protected)/templates/new/page.tsx</files>
  <action>
    Restructure the page to use PanelGroup for split-pane layout:

    1. Import { Panel, PanelGroup, PanelResizeHandle } from 'react-resizable-panels'
    2. Wrap main content in PanelGroup with direction="horizontal"
    3. Left panel (60% default, 40% min): Editor form with sections
    4. PanelResizeHandle: styled as thin vertical bar (w-1.5 bg-border hover:bg-brand)
    5. Right panel (40% default, 25% min): TemplatePreview component
    6. Add autoSaveId="template-builder-layout" to persist user's preferred split

    Layout structure:
    ```tsx
    <div className="h-[calc(100vh-64px)]"> {/* Full height minus header */}
      <PanelGroup direction="horizontal" autoSaveId="template-builder-layout">
        <Panel defaultSize={60} minSize={40}>
          <div className="h-full overflow-y-auto p-6">
            {/* Existing form content */}
          </div>
        </Panel>
        <PanelResizeHandle className="w-1.5 bg-border hover:bg-brand transition-colors cursor-col-resize" />
        <Panel defaultSize={40} minSize={25}>
          <div className="h-full overflow-y-auto p-6 bg-surface-muted">
            <TemplatePreview
              name={formData.name}
              description={formData.description}
              sections={sections}
            />
          </div>
        </Panel>
      </PanelGroup>
    </div>
    ```

    Move the breadcrumb ABOVE the PanelGroup.
    Remove the max-w-3xl constraint since we're using full width now.
  </action>
  <verify>cd app && npx tsc --noEmit passes</verify>
  <done>Split pane layout renders with resizable panels</done>
</task>

<task type="auto">
  <name>Task 2: Replace sections list with SectionList component</name>
  <files>app/app/(protected)/templates/new/page.tsx</files>
  <action>
    Replace the manual sections rendering with SectionList component:

    1. Import { SectionList } from '@/components/template-builder/section-list'
    2. Replace the existing sections.map() rendering with:
       ```tsx
       <SectionList
         sections={sections}
         onReorder={setSections}
         onUpdateSection={(id, updates) => {
           setSections(sections.map(s => s.id === id ? { ...s, ...updates } : s));
         }}
         onRemoveSection={(id) => {
           setSections(sections.filter(s => s.id !== id));
         }}
       />
       ```
    3. Keep the "Add Section" input above the SectionList
    4. Remove the old manual section card rendering

    The SectionList handles:
    - DndContext with sensors
    - SortableContext for reordering
    - Rendering each SortableSection
    - Accessible announcements
  </action>
  <verify>cd app && npx tsc --noEmit passes</verify>
  <done>Sections render via SectionList with drag-drop support</done>
</task>

<task type="auto">
  <name>Task 3: Add CreationPathwayModal and import JSON flow</name>
  <files>app/app/(protected)/templates/new/page.tsx</files>
  <action>
    Add pathway selection modal and JSON import capability:

    1. Import { CreationPathwayModal, PathwayType } from '@/components/template-builder/creation-pathway-modal'
    2. Import { templateFormSchema, formatZodErrors } from '@/lib/validation/template-schema'
    3. Add state: const [showPathwayModal, setShowPathwayModal] = useState(true) // Show on mount
    4. Add state: const [selectedPathway, setSelectedPathway] = useState<PathwayType | null>(null)
    5. Add hidden file input ref: const fileInputRef = useRef<HTMLInputElement>(null)

    Handle pathway selection:
    ```tsx
    const handlePathwaySelect = (pathway: PathwayType) => {
      setSelectedPathway(pathway);
      setShowPathwayModal(false);

      if (pathway === 'import') {
        fileInputRef.current?.click();
      }
      // 'ai' pathway handled in Plan 05
      // 'clone' needs navigation to template list with clone mode
      // 'manual' is default, just close modal
    };
    ```

    Add JSON import handler:
    ```tsx
    const handleImportFile = async (e: React.ChangeEvent<HTMLInputElement>) => {
      const file = e.target.files?.[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        // Validate against schema
        const result = templateFormSchema.safeParse(data);
        if (!result.success) {
          showToast('Invalid template format: ' + Object.values(formatZodErrors(result.error))[0], 'error');
          return;
        }

        // Populate form with validated data
        setFormData({
          name: result.data.name,
          modality: result.data.modality,
          bodyPart: result.data.bodyPart,
          description: result.data.description,
          content: result.data.content || '',
        });
        if (result.data.sections) {
          setSections(result.data.sections);
        }
        showToast('Template imported successfully', 'success');
      } catch {
        showToast('Failed to parse JSON file', 'error');
      }

      // Reset file input
      e.target.value = '';
    };
    ```

    Add file input (hidden) and "Change Pathway" button:
    ```tsx
    <input
      type="file"
      ref={fileInputRef}
      accept=".json"
      onChange={handleImportFile}
      className="hidden"
    />

    {/* In the form header area, add button to re-open modal */}
    <Button variant="outline" size="sm" onClick={() => setShowPathwayModal(true)}>
      Change Creation Method
    </Button>
    ```

    Add modal render:
    ```tsx
    <CreationPathwayModal
      open={showPathwayModal}
      onOpenChange={setShowPathwayModal}
      onSelect={handlePathwaySelect}
    />
    ```

    For clone pathway: Navigate to /templates?clone=true to let user select template to clone.
  </action>
  <verify>cd app && npx tsc --noEmit passes</verify>
  <done>Pathway modal shows on mount, import flow validates JSON</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd app && npx tsc --noEmit` passes
- [ ] Split pane layout renders with editor left, preview right
- [ ] Sections use SectionList with drag handles visible
- [ ] Pathway modal appears on page load
- [ ] "Import" pathway triggers file picker
- [ ] JSON import populates form with validated data
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Split pane resizes correctly
- Sections can be reordered via drag-drop
- Import validates and populates form
</success_criteria>

<output>
After completion, create `.planning/phases/15-template-creation-ux-overhaul/15-04-SUMMARY.md`
</output>
