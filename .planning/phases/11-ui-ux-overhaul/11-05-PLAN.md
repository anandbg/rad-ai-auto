---
phase: 11-ui-ux-overhaul
plan: 05
type: execute
wave: 3
depends_on: ["11-03", "11-04"]
files_modified:
  - app/styles/globals.css
  - app/app/layout.tsx
autonomous: false

must_haves:
  truths:
    - "All text meets WCAG 2.1 AA contrast ratio (4.5:1 for normal, 3:1 for large)"
    - "Focus indicators are visible on all interactive elements"
    - "Dark mode applies consistently across all pages"
    - "prefers-reduced-motion disables all animations"
  artifacts:
    - path: "app/styles/globals.css"
      provides: "Verified/enhanced design tokens"
      contains: "WCAG\\|contrast\\|focus"
    - path: "app/app/layout.tsx"
      provides: "Theme script for flash prevention"
      contains: "data-theme\\|localStorage"
  key_links:
    - from: "app/app/layout.tsx"
      to: "app/styles/globals.css"
      via: "CSS variables applied via data-theme"
      pattern: "data-theme"
---

<objective>
Verify accessibility compliance (WCAG 2.1 AA) and dark mode consistency across the application.

Purpose: HHS Section 504 requires WCAG 2.1 AA compliance for healthcare apps by May 2026. This plan ensures the UI overhaul meets accessibility standards and dark mode works correctly without flash on load.

Output: Verified contrast ratios, consistent focus states, working dark mode with no flash, and reduced motion support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-ui-ux-overhaul/11-RESEARCH.md

# Design tokens:
@app/styles/globals.css

# Root layout:
@app/app/layout.tsx

# Tailwind config for theme:
@app/tailwind.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add theme initialization script to prevent flash</name>
  <files>app/app/layout.tsx</files>
  <action>
Read the existing layout.tsx. Add inline script in <head> to set theme before body renders.

This prevents flash of wrong theme (FOUC) on page load.

Add to the <head> section:
```tsx
<head>
  <script
    dangerouslySetInnerHTML={{
      __html: `
        (function() {
          try {
            var theme = localStorage.getItem('theme');
            if (!theme) {
              theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            document.documentElement.dataset.theme = theme;
          } catch (e) {}
        })();
      `,
    }}
  />
</head>
```

IMPORTANT: This must run synchronously before body renders.
IMPORTANT: Use try/catch for localStorage access (can fail in some contexts).
IMPORTANT: Keep all existing layout content and providers.
  </action>
  <verify>
Build succeeds: `cd app && npm run build`
Theme applies immediately on page load (no flash)
  </verify>
  <done>Theme initializes before render, no FOUC</done>
</task>

<task type="auto">
  <name>Task 2: Audit and fix contrast ratios</name>
  <files>app/styles/globals.css</files>
  <action>
Read the existing globals.css. Verify and adjust color contrast.

Use these minimum ratios (WCAG 2.1 AA):
- Normal text (<18px or <14px bold): 4.5:1
- Large text (≥18px or ≥14px bold): 3:1
- UI components and graphics: 3:1

Check each color variable against background:

**Light mode (--bg: #ffffff):**
- --text-primary (#0f172a): 15.76:1 ✓
- --text-secondary (#475569): 6.97:1 ✓
- --text-muted (#64748b): 4.68:1 ✓ (barely passes, could improve)
- --brand (#7c2d3c): 7.05:1 ✓

**Dark mode (--bg: #0f172a):**
- --text-primary (#f8fafc): 15.76:1 ✓
- --text-secondary (#cbd5e1): 10.87:1 ✓
- --text-muted (#94a3b8): 6.63:1 ✓
- --brand (#e08a98): Check and verify ≥4.5:1

If any fail, adjust the color to meet ratio while maintaining visual design.

Also verify:
- Focus color (--focus: #3b82f6) against both backgrounds
- Success/warning/danger colors

Add comment at top of :root section:
```css
/* Design Tokens - WCAG 2.1 AA Compliant
 * All text colors: ≥4.5:1 contrast ratio
 * Focus/brand colors: ≥3:1 contrast ratio
 * Verified: [date]
 */
```
  </action>
  <verify>
Use browser DevTools or online contrast checker to verify ratios
All text readable in both light and dark mode
  </verify>
  <done>All colors meet WCAG 2.1 AA contrast requirements</done>
</task>

<task type="auto">
  <name>Task 3: Verify focus states and reduced motion</name>
  <files>app/styles/globals.css</files>
  <action>
Read globals.css and verify focus styles.

1. Ensure focus-visible styles are present and visible:
```css
:focus-visible {
  outline: 2px solid var(--focus);
  outline-offset: 2px;
}
```

2. Add reduced motion media query to disable all animations:
```css
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}
```

3. Verify button/input focus rings are visible on both themes

IMPORTANT: Don't remove existing focus styles - enhance if needed.
IMPORTANT: The motion components already use useReducedMotion - this CSS is a fallback.
  </action>
  <verify>
Tab through the app - all interactive elements show focus ring
Toggle reduced motion in system settings - animations should stop
  </verify>
  <done>Focus states visible, reduced motion respected</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Accessibility compliance: contrast ratios, focus states, dark mode, reduced motion support</what-built>
  <how-to-verify>
    1. Run: `cd app && npm run dev`

    2. Test dark mode flash:
       - Set theme to dark in localStorage: `localStorage.setItem('theme', 'dark')`
       - Hard refresh the page (Cmd+Shift+R)
       - Should NOT see white flash before dark theme applies

    3. Test contrast in light mode:
       - Visit /dashboard
       - All text should be clearly readable
       - Muted text (dates, secondary info) still readable

    4. Switch to dark mode:
       - Toggle theme (if toggle exists) or set localStorage
       - Refresh page
       - All text should be clearly readable
       - Brand color (burgundy/pink) should be visible against dark background

    5. Test focus states:
       - Use Tab key to navigate through the page
       - Every button, link, and input should show visible focus ring
       - Focus ring should be visible on both light and dark themes

    6. Test reduced motion (macOS: System Preferences > Accessibility > Display > Reduce motion):
       - Enable reduced motion in OS settings
       - Refresh the page
       - Page transitions and animations should be instant/disabled

    7. Spot check other pages:
       - /login, /settings, /templates
       - Consistent contrast and focus behavior
  </how-to-verify>
  <resume-signal>Type "approved" if accessibility checks pass, or describe any contrast/focus/motion issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd app && npm run build` succeeds
- [ ] No FOUC (theme flash) on page load
- [ ] All text meets contrast requirements
- [ ] Focus rings visible on all interactive elements
- [ ] Reduced motion disables animations
- [ ] Human verification passed
</verification>

<success_criteria>

- All tasks completed
- Human approved accessibility verification
- WCAG 2.1 AA compliance achieved
- Dark mode works consistently without flash
</success_criteria>

<output>
After completion, create `.planning/phases/11-ui-ux-overhaul/11-05-SUMMARY.md`
</output>
