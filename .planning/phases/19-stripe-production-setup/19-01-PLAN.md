---
phase: 19-stripe-production-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app/.env.local]
autonomous: false

must_haves:
  truths:
    - "Stripe CLI is installed and authenticated"
    - "stripe listen forwards events to localhost:3000/api/stripe/webhook"
    - "STRIPE_WEBHOOK_SECRET in .env.local matches CLI-provided secret"
  artifacts:
    - path: "app/.env.local"
      provides: "STRIPE_WEBHOOK_SECRET from CLI"
      contains: "whsec_"
  key_links:
    - from: "Stripe CLI"
      to: "/api/stripe/webhook"
      via: "stripe listen --forward-to"
      pattern: "localhost:3000/api/stripe/webhook"
---

<objective>
Set up local webhook testing with Stripe CLI for development workflow.

Purpose: Enable local testing of webhook events without deploying to production. The Stripe CLI forwards test events to localhost, allowing rapid iteration on webhook handling.
Output: Authenticated Stripe CLI with webhook forwarding configured and documented.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/app/api/stripe/webhook/route.ts
@app/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check and install Stripe CLI</name>
  <files>n/a</files>
  <action>
    Run `stripe --version` to check if Stripe CLI is installed.

    If NOT installed (command not found):
    - Run: `brew install stripe/stripe-cli/stripe`
    - Verify installation: `stripe --version`

    If already installed:
    - Record the CLI version for documentation

    Output the version number.
  </action>
  <verify>stripe --version returns a version number (e.g., stripe version 1.x.x)</verify>
  <done>Stripe CLI installed and version confirmed</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Authenticate Stripe CLI with your Stripe account</action>
  <instructions>
    I've verified the Stripe CLI installation. Now you need to authenticate it.

    **Run this command in your terminal:**
    ```bash
    stripe login
    ```

    This will:
    1. Open your browser to Stripe's authentication page
    2. Ask you to allow CLI access to your account
    3. Complete the pairing in your terminal

    **Important:** Make sure you're logging into the account that has the AI Radiologist products configured (Plus £10/mo, Pro £20/mo).
  </instructions>
  <verification>stripe whoami returns your account email</verification>
  <resume-signal>Type "done" when authenticated, then I'll verify with `stripe whoami`</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Verify Stripe CLI authentication</name>
  <files>n/a</files>
  <action>
    Run `stripe whoami` to confirm authentication is successful.
    Record the account email/ID for documentation.

    Expected output format:
    ```
    You are logged in as: [email]
    Account: [account name]
    ```
  </action>
  <verify>stripe whoami outputs account information without errors</verify>
  <done>Stripe CLI authenticated and verified</done>
</task>

<task type="auto">
  <name>Task 4: Start webhook forwarding in background and capture secret</name>
  <files>app/.env.local</files>
  <action>
    1. Start stripe listen in background mode to capture the webhook secret:
       ```bash
       stripe listen --forward-to localhost:3000/api/stripe/webhook --print-secret
       ```
       This prints the webhook secret immediately.

    2. Capture the `whsec_xxxxx` secret from the output.

    3. Read the current app/.env.local file.

    4. Update app/.env.local with the new webhook secret:
       - If STRIPE_WEBHOOK_SECRET exists, replace its value
       - If it doesn't exist, add it

       ```
       STRIPE_WEBHOOK_SECRET=whsec_xxxxx
       ```

    **Note:** The CLI secret changes each time you run `stripe listen`. For local dev, this is fine - just re-copy if you restart the CLI.
  </action>
  <verify>
    - .env.local contains STRIPE_WEBHOOK_SECRET starting with whsec_
    - stripe listen process can be started successfully
  </verify>
  <done>Webhook secret captured and configured in .env.local</done>
</task>

<task type="auto">
  <name>Task 5: Create testing workflow documentation</name>
  <files>.planning/phases/19-stripe-production-setup/TESTING-WORKFLOW.md</files>
  <action>
    Create a testing workflow document with:

    ```markdown
    # Stripe Local Testing Workflow

    ## Quick Start

    Run these commands in two separate terminals:

    **Terminal 1: Start the app**
    ```bash
    cd app && npm run dev
    ```

    **Terminal 2: Start webhook forwarding**
    ```bash
    stripe listen --forward-to localhost:3000/api/stripe/webhook
    ```

    Copy the `whsec_xxxxx` secret to `.env.local` as `STRIPE_WEBHOOK_SECRET`.

    ## Test Event Commands

    With both processes running, trigger test events:

    ```bash
    # Test checkout completion
    stripe trigger checkout.session.completed

    # Test subscription update
    stripe trigger customer.subscription.updated

    # Test subscription cancellation
    stripe trigger customer.subscription.deleted

    # Test failed payment
    stripe trigger invoice.payment_failed
    ```

    ## What to Verify After Each Event

    1. **Terminal output**: Look for `[Stripe Webhook]` log messages
    2. **Expected logs**:
       - `checkout.session.completed` → "Activated subscription"
       - `customer.subscription.updated` → "Updated subscription"
       - `customer.subscription.deleted` → "Downgraded to free"
       - `invoice.payment_failed` → "Marked subscription as past_due"

    ## Troubleshooting

    | Issue | Solution |
    |-------|----------|
    | "Not authenticated" | Run `stripe login` |
    | "Webhook signature verification failed" | Copy new secret from `stripe listen` output to .env.local, restart app |
    | "Connection refused" | Ensure app is running on port 3000 |
    | "No user_id in metadata" | CLI triggers use synthetic data - this is expected, full E2E test in Plan 02 |

    ## Test Cards for Checkout

    | Card Number | Result |
    |-------------|--------|
    | 4242 4242 4242 4242 | Success |
    | 4000 0000 0000 0002 | Decline |
    | 4000 0000 0000 3220 | 3D Secure required |

    Always use future expiry date (e.g., 12/30), any CVC (e.g., 123).
    ```
  </action>
  <verify>TESTING-WORKFLOW.md exists with all sections</verify>
  <done>Local testing workflow documented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `stripe --version` returns CLI version
- [ ] `stripe whoami` returns authenticated account
- [ ] STRIPE_WEBHOOK_SECRET in .env.local starts with `whsec_`
- [ ] TESTING-WORKFLOW.md documents the full local testing process
</verification>

<success_criteria>
- Stripe CLI installed and authenticated
- Webhook secret configured in .env.local
- Testing workflow documented for future sessions
</success_criteria>

<output>
After completion, create `.planning/phases/19-stripe-production-setup/19-01-SUMMARY.md`
</output>
