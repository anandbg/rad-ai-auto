---
phase: 19-stripe-production-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app/.env.local]
autonomous: false

must_haves:
  truths:
    - "Stripe CLI is installed and authenticated"
    - "stripe listen forwards events to localhost:3000/api/stripe/webhook"
    - "STRIPE_WEBHOOK_SECRET in .env.local matches CLI-provided secret"
  artifacts:
    - path: "app/.env.local"
      provides: "STRIPE_WEBHOOK_SECRET from CLI"
      contains: "whsec_"
  key_links:
    - from: "Stripe CLI"
      to: "/api/stripe/webhook"
      via: "stripe listen --forward-to"
      pattern: "localhost:3000/api/stripe/webhook"
---

<objective>
Set up local webhook testing with Stripe CLI for development workflow.

Purpose: Enable local testing of webhook events without deploying to production. The Stripe CLI forwards test events to localhost, allowing rapid iteration on webhook handling.
Output: Authenticated Stripe CLI with webhook forwarding configured and documented.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/app/api/stripe/webhook/route.ts
@app/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check Stripe CLI installation status</name>
  <files>n/a</files>
  <action>
    Run `which stripe` or `stripe --version` to check if Stripe CLI is installed.

    If NOT installed:
    - macOS: Use `brew install stripe/stripe-cli/stripe`
    - Other: Document that user needs to install from https://stripe.com/docs/stripe-cli

    Record the CLI version for documentation.
  </action>
  <verify>stripe --version returns a version number (e.g., stripe version 1.x.x)</verify>
  <done>CLI installation status confirmed and documented</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Authenticate Stripe CLI with your Stripe account</action>
  <instructions>
    I've verified the Stripe CLI installation. Now you need to authenticate it.

    **Run this command in your terminal:**
    ```bash
    stripe login
    ```

    This will:
    1. Open your browser to Stripe's authentication page
    2. Ask you to allow CLI access to your account
    3. Complete the pairing in your terminal

    **Important:** Make sure you're logging into the account that has the AI Radiologist products configured (Plus £10/mo, Pro £20/mo).
  </instructions>
  <verification>stripe whoami returns your account email</verification>
  <resume-signal>Type "done" when authenticated, then I'll verify with `stripe whoami`</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Verify Stripe CLI authentication</name>
  <files>n/a</files>
  <action>
    Run `stripe whoami` to confirm authentication is successful.
    Record the account email/ID for documentation.
  </action>
  <verify>stripe whoami outputs account information without errors</verify>
  <done>Stripe CLI authenticated and verified</done>
</task>

<task type="auto">
  <name>Task 4: Start webhook forwarding and capture secret</name>
  <files>app/.env.local</files>
  <action>
    1. Run: `stripe listen --forward-to localhost:3000/api/stripe/webhook`
    2. The CLI will output a webhook signing secret like: `whsec_xxxxx`
    3. Update app/.env.local with this secret:
       ```
       STRIPE_WEBHOOK_SECRET=whsec_xxxxx
       ```

    **Important:** The CLI secret is different from Dashboard webhook secrets. It's temporary and regenerates each time you run `stripe listen`.

    Keep the `stripe listen` process running in a terminal for testing.
  </action>
  <verify>
    - stripe listen process is running
    - .env.local contains STRIPE_WEBHOOK_SECRET starting with whsec_
  </verify>
  <done>Webhook forwarding active with secret configured</done>
</task>

<task type="auto">
  <name>Task 5: Document local testing workflow</name>
  <files>.planning/phases/19-stripe-production-setup/TESTING-WORKFLOW.md</files>
  <action>
    Create a testing workflow document with:

    1. **Quick Start** - Commands to run in two terminals:
       - Terminal 1: `cd app && npm run dev`
       - Terminal 2: `stripe listen --forward-to localhost:3000/api/stripe/webhook`

    2. **Test Event Commands** - How to trigger test events:
       ```bash
       stripe trigger checkout.session.completed
       stripe trigger customer.subscription.updated
       stripe trigger customer.subscription.deleted
       stripe trigger invoice.payment_failed
       ```

    3. **Verification** - What to check after each event:
       - Terminal output from webhook handler
       - Database changes in subscriptions table

    4. **Troubleshooting** - Common issues:
       - CLI not authenticated: `stripe login`
       - Secret mismatch: Copy new secret from `stripe listen` output
       - Port conflict: Ensure app is running on 3000
  </action>
  <verify>TESTING-WORKFLOW.md exists with all sections</verify>
  <done>Local testing workflow documented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `stripe --version` returns CLI version
- [ ] `stripe whoami` returns authenticated account
- [ ] `stripe listen` is running and forwarding to localhost:3000
- [ ] STRIPE_WEBHOOK_SECRET in .env.local starts with `whsec_`
- [ ] TESTING-WORKFLOW.md documents the full local testing process
</verification>

<success_criteria>
- Stripe CLI installed and authenticated
- Webhook forwarding configured for localhost
- Environment variable updated with CLI webhook secret
- Testing workflow documented for future sessions
</success_criteria>

<output>
After completion, create `.planning/phases/19-stripe-production-setup/19-01-SUMMARY.md`
</output>
