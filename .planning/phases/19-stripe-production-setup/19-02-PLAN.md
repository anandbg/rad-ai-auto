---
phase: 19-stripe-production-setup
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified: [app/app/api/stripe/webhook/route.ts]
autonomous: true

must_haves:
  truths:
    - "checkout.session.completed creates/activates subscription in database"
    - "customer.subscription.updated reflects plan changes in database"
    - "customer.subscription.deleted sets plan to free in database"
    - "invoice.payment_failed sets status to past_due in database"
    - "End-to-end flow: user checkout → webhook → database updated → UI shows new plan"
  artifacts:
    - path: "app/app/api/stripe/webhook/route.ts"
      provides: "Webhook handler for all subscription events"
      exports: ["POST"]
    - path: ".planning/phases/19-stripe-production-setup/TEST-RESULTS.md"
      provides: "Documented test results with screenshots"
  key_links:
    - from: "Stripe Checkout"
      to: "/api/stripe/webhook"
      via: "stripe webhook POST"
    - from: "webhook handler"
      to: "subscriptions table"
      via: "supabase.from('subscriptions').upsert/update"
---

<objective>
Test webhook handler and execute full end-to-end subscription flow using agent-browser automation.

Purpose: Verify the webhook handler processes all events correctly and the complete subscription lifecycle works. Use the agent-browser skill to automate the entire checkout flow, eliminating manual testing.

Output: Verified webhook handling with automated E2E test and documented results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@.claude/skills/agent-browser/SKILL.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-stripe-production-setup/19-01-SUMMARY.md

@app/app/api/stripe/webhook/route.ts
@app/app/api/billing/checkout/route.ts
@app/app/(protected)/billing/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify webhook handler code structure</name>
  <files>app/app/api/stripe/webhook/route.ts</files>
  <action>
    Read and verify the webhook handler handles all required events:

    1. `checkout.session.completed` - Should upsert subscription with plan/status
    2. `customer.subscription.created` - Should update subscription
    3. `customer.subscription.updated` - Should update plan/status
    4. `customer.subscription.deleted` - Should set plan to 'free', status to 'canceled'
    5. `invoice.payment_succeeded` - Should log (credit reset is TODO)
    6. `invoice.payment_failed` - Should set status to 'past_due'

    Verify:
    - Signature verification happens FIRST (security)
    - Each handler has proper error handling with logging
    - Database operations use service role client (for RLS bypass)
    - getPlanFromPriceId correctly maps price IDs to plan names

    Document any issues found. If handlers are incomplete, note for fixing.
  </action>
  <verify>All 6 event types have handlers with logging and error handling</verify>
  <done>Webhook handler code structure verified complete</done>
</task>

<task type="auto">
  <name>Task 2: Start dev server and stripe listen in background</name>
  <files>n/a</files>
  <action>
    Ensure the prerequisites are running for E2E testing:

    1. Check if dev server is running on port 3000:
       ```bash
       curl -s http://localhost:3000 > /dev/null && echo "Dev server running" || echo "Dev server not running"
       ```

    2. If not running, start it in background:
       ```bash
       cd /Users/anand/rad-ai-auto/app && npm run dev &
       ```

    3. Wait for server to be ready (up to 30 seconds).

    4. Verify stripe CLI is authenticated:
       ```bash
       stripe whoami
       ```

    5. Start stripe listen in background if not already running:
       ```bash
       stripe listen --forward-to localhost:3000/api/stripe/webhook &
       ```

    6. Wait a few seconds for both to initialize.
  </action>
  <verify>
    - curl localhost:3000 returns 200
    - stripe whoami shows authenticated account
  </verify>
  <done>Dev server and webhook forwarding ready</done>
</task>

<task type="auto">
  <name>Task 3: Test CLI webhook triggers</name>
  <files>n/a</files>
  <action>
    Test webhook events using Stripe CLI triggers to verify handler logic:

    **Test 1: checkout.session.completed**
    ```bash
    stripe trigger checkout.session.completed
    ```
    Expected: "Verified event: checkout.session.completed" in logs

    **Test 2: customer.subscription.updated**
    ```bash
    stripe trigger customer.subscription.updated
    ```
    Expected: "Subscription updated" in logs

    **Test 3: customer.subscription.deleted**
    ```bash
    stripe trigger customer.subscription.deleted
    ```
    Expected: "Downgraded to free" in logs

    **Test 4: invoice.payment_failed**
    ```bash
    stripe trigger invoice.payment_failed
    ```
    Expected: "Marked subscription as past_due" in logs

    Note: CLI triggers use synthetic test data, so database updates may fail on user lookup (expected). We're verifying the handler logic executes without crashing.

    Record output from each trigger.
  </action>
  <verify>All 4 trigger commands execute without webhook signature errors</verify>
  <done>CLI trigger tests completed</done>
</task>

<task type="auto">
  <name>Task 4: Automated E2E checkout flow with agent-browser</name>
  <files>n/a</files>
  <action>
    Use the agent-browser skill to automate the full checkout flow.

    **Step 1: Navigate to app and login**
    ```bash
    # Open login page
    agent-browser open http://localhost:3000/login

    # Get interactive elements
    agent-browser snapshot -i

    # Fill login form (refs from snapshot, e.g., @e1 for email, @e2 for password)
    agent-browser fill @e1 "test@example.com"   # Use actual test user email
    agent-browser fill @e2 "testpassword123"     # Use actual test password

    # Click login button
    agent-browser click @e3   # Login/Submit button ref

    # Wait for redirect
    agent-browser wait --url "**/workspace"
    ```

    **Step 2: Navigate to billing page**
    ```bash
    agent-browser open http://localhost:3000/billing
    agent-browser wait --load networkidle
    agent-browser snapshot -i

    # Take screenshot of current state
    agent-browser screenshot .playwright-mcp/billing-before-upgrade.png
    ```
    Note the current plan shown.

    **Step 3: Initiate checkout for Plus plan**
    ```bash
    # Find and click Upgrade button for Plus (second plan card)
    agent-browser snapshot -i
    # Look for button with text "Upgrade" in Plus card
    agent-browser find text "Upgrade" click   # Or use ref from snapshot

    # Wait for redirect to Stripe Checkout
    agent-browser wait --url "**/checkout.stripe.com**"
    agent-browser wait --load networkidle
    ```

    **Step 4: Complete Stripe Checkout form**
    ```bash
    # Snapshot the Stripe checkout page
    agent-browser snapshot -i

    # Stripe uses iframes - may need to switch to frame
    # Find and fill card number field
    agent-browser find label "Card number" fill "4242424242424242"
    # Or use frame switching if needed:
    # agent-browser frame "iframe"
    # agent-browser fill @cardNumber "4242424242424242"

    # Fill expiry
    agent-browser find label "Expiry" fill "12/30"
    # Or: agent-browser fill @expiry "1230"

    # Fill CVC
    agent-browser find label "CVC" fill "123"

    # Fill any required billing details
    agent-browser find label "Name on card" fill "Test User"

    # Click Subscribe/Pay button
    agent-browser find role button click --name "Subscribe"
    # Or: agent-browser click @submitButton

    # Wait for redirect back to app
    agent-browser wait --url "**/localhost:3000/billing**"
    agent-browser wait --load networkidle
    ```

    **Step 5: Verify subscription updated**
    ```bash
    # Capture the billing page after checkout
    agent-browser snapshot -i
    agent-browser screenshot .playwright-mcp/billing-after-upgrade.png

    # Get the current plan text
    agent-browser get text ".text-brand"  # Or find the plan name element
    ```
    Verify "Plus" plan is now shown as current.

    **Step 6: Verify database update**
    Use Supabase MCP to query:
    ```
    mcp__supabase__postgrestRequest GET /subscriptions?select=plan,status
    ```
    Verify plan = 'plus' and status = 'active'.

    If any step fails, document the failure and take a screenshot.
  </action>
  <verify>
    - Screenshots captured at each step
    - Billing page shows "Plus" plan after checkout
    - Database shows plan='plus', status='active'
  </verify>
  <done>E2E checkout flow automated and verified</done>
</task>

<task type="auto">
  <name>Task 5: Automated Customer Portal cancellation test</name>
  <files>n/a</files>
  <action>
    Continue agent-browser automation to test subscription cancellation.

    **Step 1: Click Manage Subscription**
    ```bash
    # From billing page, snapshot to find Manage button
    agent-browser snapshot -i

    # Click "Manage Subscription" button
    agent-browser find text "Manage Subscription" click
    # Or: agent-browser click @manageButton

    # Wait for Stripe Portal
    agent-browser wait --url "**/billing.stripe.com**"
    agent-browser wait --load networkidle
    ```

    **Step 2: Cancel subscription in portal**
    ```bash
    agent-browser snapshot -i

    # Look for cancel option
    agent-browser find text "Cancel" click
    # Or: agent-browser find text "Cancel plan" click

    # Confirm cancellation in dialog
    agent-browser snapshot -i
    agent-browser find text "Cancel subscription" click
    # Or: agent-browser find role button click --name "Cancel subscription"

    # Wait for confirmation
    agent-browser wait 2000
    ```

    **Step 3: Return to app and verify**
    ```bash
    agent-browser open http://localhost:3000/billing
    agent-browser wait --load networkidle
    agent-browser snapshot -i
    agent-browser screenshot .playwright-mcp/billing-after-cancel.png

    # Check the plan displayed
    agent-browser get text ".text-brand"
    ```
    Verify "Free" plan is shown (or canceled status).

    **Step 4: Verify database update**
    Use Supabase MCP:
    ```
    mcp__supabase__postgrestRequest GET /subscriptions?select=plan,status
    ```
    Verify plan = 'free' and status = 'canceled'.
  </action>
  <verify>
    - Customer Portal opened and cancellation completed
    - Billing page shows Free plan after cancel
    - Database shows plan='free', status='canceled'
  </verify>
  <done>Customer Portal cancellation automated and verified</done>
</task>

<task type="auto">
  <name>Task 6: Close browser and document test results</name>
  <files>.planning/phases/19-stripe-production-setup/TEST-RESULTS.md</files>
  <action>
    Close the browser session:
    ```bash
    agent-browser close
    ```

    Create TEST-RESULTS.md documenting all test results:

    ```markdown
    # Stripe Integration Test Results

    **Date:** [timestamp]
    **Tester:** Claude (automated via agent-browser skill)

    ## CLI Trigger Tests

    | Event | Command | Result | Notes |
    |-------|---------|--------|-------|
    | checkout.session.completed | `stripe trigger checkout.session.completed` | [PASS/FAIL] | [notes] |
    | customer.subscription.updated | `stripe trigger customer.subscription.updated` | [PASS/FAIL] | [notes] |
    | customer.subscription.deleted | `stripe trigger customer.subscription.deleted` | [PASS/FAIL] | [notes] |
    | invoice.payment_failed | `stripe trigger invoice.payment_failed` | [PASS/FAIL] | [notes] |

    ## E2E Checkout Test (agent-browser automated)

    **Flow:** Login → Billing → Upgrade to Plus → Stripe Checkout → Return

    | Step | Action | Result | Screenshot |
    |------|--------|--------|------------|
    | 1 | Login | [PASS/FAIL] | - |
    | 2 | Navigate to billing | [PASS/FAIL] | billing-before-upgrade.png |
    | 3 | Click Upgrade | [PASS/FAIL] | - |
    | 4 | Complete Stripe Checkout | [PASS/FAIL] | - |
    | 5 | Verify billing page | [PASS/FAIL] | billing-after-upgrade.png |
    | 6 | Verify database | [PASS/FAIL] | plan='plus', status='active' |

    ## Customer Portal Cancellation Test

    **Flow:** Manage Subscription → Portal → Cancel → Return

    | Step | Action | Result | Screenshot |
    |------|--------|--------|------------|
    | 1 | Click Manage Subscription | [PASS/FAIL] | - |
    | 2 | Cancel in Portal | [PASS/FAIL] | - |
    | 3 | Verify billing page | [PASS/FAIL] | billing-after-cancel.png |
    | 4 | Verify database | [PASS/FAIL] | plan='free', status='canceled' |

    ## Issues Found

    [List any issues or "None"]

    ## Summary

    - **CLI Triggers:** X/4 passed
    - **E2E Checkout:** [PASS/FAIL]
    - **Portal Cancellation:** [PASS/FAIL]
    - **Overall:** [READY FOR PRODUCTION / ISSUES NEED FIXING]

    ## Screenshots

    All screenshots saved to `.playwright-mcp/` directory:
    - billing-before-upgrade.png
    - billing-after-upgrade.png
    - billing-after-cancel.png
    ```
  </action>
  <verify>TEST-RESULTS.md exists with complete results</verify>
  <done>Test results documented and browser closed</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Webhook handler code verified for all 6 event types
- [ ] CLI triggers execute without signature errors
- [ ] E2E checkout completed via agent-browser automation
- [ ] Database reflects subscription changes
- [ ] Customer Portal cancellation tested
- [ ] TEST-RESULTS.md documents all outcomes
- [ ] Browser session closed
</verification>

<success_criteria>
- All webhook event types verified working
- Full subscription lifecycle tested automatically (signup → upgrade → cancel)
- Database correctly reflects subscription state changes
- Test results documented with screenshots
</success_criteria>

<output>
After completion, create `.planning/phases/19-stripe-production-setup/19-02-SUMMARY.md`
</output>
