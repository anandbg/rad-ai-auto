---
phase: 19-stripe-production-setup
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified: [app/app/api/stripe/webhook/route.ts]
autonomous: false

must_haves:
  truths:
    - "checkout.session.completed creates/activates subscription in database"
    - "customer.subscription.updated reflects plan changes in database"
    - "customer.subscription.deleted sets plan to free in database"
    - "invoice.payment_failed sets status to past_due in database"
    - "End-to-end flow: user checkout → webhook → database updated → UI shows new plan"
  artifacts:
    - path: "app/app/api/stripe/webhook/route.ts"
      provides: "Webhook handler for all subscription events"
      exports: ["POST"]
  key_links:
    - from: "Stripe test event"
      to: "/api/stripe/webhook"
      via: "stripe listen forwarding"
    - from: "webhook handler"
      to: "subscriptions table"
      via: "supabase.from('subscriptions').upsert/update"
---

<objective>
Verify webhook handler processes all subscription events correctly and test end-to-end subscription flow.

Purpose: Ensure the existing webhook handler code actually works before configuring production. Test with real Stripe test events to validate database updates.
Output: Verified webhook handling with documented test results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-stripe-production-setup/19-01-SUMMARY.md

@app/app/api/stripe/webhook/route.ts
@app/app/api/billing/checkout/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify webhook handler code handles all events</name>
  <files>app/app/api/stripe/webhook/route.ts</files>
  <action>
    Review the webhook handler and verify it handles all required events:

    1. `checkout.session.completed` - Should upsert subscription with plan/status
    2. `customer.subscription.created` - Should update subscription
    3. `customer.subscription.updated` - Should update plan/status
    4. `customer.subscription.deleted` - Should set plan to 'free', status to 'canceled'
    5. `invoice.payment_succeeded` - Should log (credit reset is TODO)
    6. `invoice.payment_failed` - Should set status to 'past_due'

    Check that:
    - Signature verification happens FIRST (security)
    - Each handler has proper error handling with logging
    - Database operations use service role client for RLS bypass

    If any handlers are incomplete or have bugs, fix them.
  </action>
  <verify>All 6 event types have handlers with logging and error handling</verify>
  <done>Webhook handler code verified complete</done>
</task>

<task type="auto">
  <name>Task 2: Test webhook events with Stripe CLI triggers</name>
  <files>n/a</files>
  <action>
    With the app running (`npm run dev`) and `stripe listen` active, test each event type:

    **Test 1: checkout.session.completed**
    ```bash
    stripe trigger checkout.session.completed
    ```
    Check webhook logs show "Checkout completed" and "Activated subscription"

    **Test 2: customer.subscription.updated**
    ```bash
    stripe trigger customer.subscription.updated
    ```
    Check logs show "Subscription updated"

    **Test 3: customer.subscription.deleted**
    ```bash
    stripe trigger customer.subscription.deleted
    ```
    Check logs show "Downgraded to free plan"

    **Test 4: invoice.payment_failed**
    ```bash
    stripe trigger invoice.payment_failed
    ```
    Check logs show "Marked subscription as past_due"

    Document the output from each trigger in the summary.

    Note: These CLI triggers use synthetic test data, so database updates may fail on user lookup. That's OK - we're verifying the handler logic executes correctly. Full E2E test is next.
  </action>
  <verify>All 4 trigger commands execute without webhook errors (signature verification passes)</verify>
  <done>CLI trigger tests completed and documented</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Webhook handler verified with CLI triggers - now testing full checkout flow</what-built>
  <how-to-verify>
    **Full End-to-End Subscription Test:**

    1. Open app in browser: http://localhost:3000
    2. Log in with a test user account (or create one)
    3. Navigate to: http://localhost:3000/billing
    4. Click "Upgrade to Plus" (or Pro)
    5. Complete Stripe Checkout using test card: `4242 4242 4242 4242`
       - Expiry: Any future date (e.g., 12/30)
       - CVC: Any 3 digits (e.g., 123)
       - ZIP: Any 5 digits (e.g., 12345)
    6. After checkout, verify:
       - You're redirected back to /billing with success
       - Billing page shows "Plus" (or "Pro") plan
       - Check `stripe listen` terminal - should show webhook events processed

    **Verify Database (optional but recommended):**
    - Open Supabase Dashboard → Table Editor → subscriptions
    - Find your user's row - plan should show 'plus' or 'pro', status 'active'

    **Test Downgrade via Customer Portal:**
    1. On billing page, click "Manage Subscription" (opens Stripe portal)
    2. Cancel the subscription
    3. Check webhook terminal shows `customer.subscription.deleted`
    4. Refresh billing page - should show "Free" plan
  </how-to-verify>
  <resume-signal>Type "verified" if the full flow works, or describe any issues found</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Document test results</name>
  <files>.planning/phases/19-stripe-production-setup/TEST-RESULTS.md</files>
  <action>
    Create TEST-RESULTS.md documenting:

    1. **CLI Trigger Tests** - Results from each stripe trigger command
    2. **E2E Checkout Test** - Steps performed, outcome
    3. **Database Verification** - What was observed in subscriptions table
    4. **Portal Cancellation Test** - Steps and outcome
    5. **Issues Found** - Any bugs or improvements needed (or "None")

    This document serves as verification evidence for the phase.
  </action>
  <verify>TEST-RESULTS.md exists with all sections completed</verify>
  <done>Test results documented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Webhook handler code review confirms all events handled
- [ ] CLI triggers (checkout, subscription update/delete, payment failed) execute without errors
- [ ] Full E2E test: checkout → webhook → database → UI all work
- [ ] Customer portal cancellation triggers webhook and updates database
- [ ] TEST-RESULTS.md documents all test outcomes
</verification>

<success_criteria>
- All webhook event types verified working
- Full subscription lifecycle tested (signup → upgrade → cancel)
- Database correctly reflects subscription state changes
- Test results documented for future reference
</success_criteria>

<output>
After completion, create `.planning/phases/19-stripe-production-setup/19-02-SUMMARY.md`
</output>
