---
phase: 19-stripe-production-setup
plan: 03
type: execute
wave: 3
depends_on: ["19-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Production webhook endpoint exists in Stripe Dashboard"
    - "Webhook receives events at production URL and processes them"
    - "Production environment variables are documented and ready"
  artifacts:
    - path: ".planning/phases/19-stripe-production-setup/PRODUCTION-CHECKLIST.md"
      provides: "Go-live checklist and credential documentation"
  key_links:
    - from: "Stripe Dashboard webhook"
      to: "production /api/stripe/webhook"
      via: "HTTPS POST with signature"
---

<objective>
Configure production webhook endpoint in Stripe Dashboard and document go-live checklist.

Purpose: Set up the production webhook so subscription events from real customers will sync to the database. Create comprehensive documentation for production launch.
Output: Configured production webhook with go-live checklist ready for deployment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-stripe-production-setup/19-01-SUMMARY.md
@.planning/phases/19-stripe-production-setup/19-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:decision" gate="blocking">
  <decision>Do you have a production domain configured?</decision>
  <context>
    Production webhooks require a publicly accessible HTTPS URL. Before configuring Stripe webhooks for production, we need to know if:
    - You have a production deployment (Vercel, etc.)
    - You have a custom domain OR a Vercel preview URL

    This determines whether we configure production webhooks now or defer until Phase 16 (Infrastructure Setup) is complete.
  </context>
  <options>
    <option id="have-domain">
      <name>Yes, I have a production URL</name>
      <pros>Can configure production webhooks now, full Stripe setup complete</pros>
      <cons>None - ready to proceed</cons>
    </option>
    <option id="no-domain">
      <name>No production URL yet (defer to Phase 16)</name>
      <pros>Focuses on test mode which is working, production setup when infrastructure ready</pros>
      <cons>Production webhooks not configured until Phase 16</cons>
    </option>
  </options>
  <resume-signal>Select: have-domain (provide your URL) or no-domain (defer production config)</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure webhook endpoint in Stripe Dashboard (test mode first)</action>
  <instructions>
    Even without production, we should register the test webhook endpoint properly:

    **1. Open Stripe Dashboard:**
    https://dashboard.stripe.com/test/webhooks

    **2. Click "Add endpoint"**

    **3. Configure endpoint:**
    - **Endpoint URL:** (depends on your choice above)
      - If have-domain: `https://your-domain.com/api/stripe/webhook`
      - If no-domain: Skip production, but consider adding a test endpoint for Vercel preview deployments
    - **Description:** "AI Radiologist subscription webhooks"

    **4. Select events to listen for:**
    - `checkout.session.completed`
    - `customer.subscription.created`
    - `customer.subscription.updated`
    - `customer.subscription.deleted`
    - `invoice.payment_succeeded`
    - `invoice.payment_failed`

    **5. Click "Add endpoint"**

    **6. Copy the Signing Secret:**
    - Click on the endpoint you just created
    - Find "Signing secret" and click "Reveal"
    - Copy the `whsec_xxxxx` value

    **Important:** This Dashboard secret is DIFFERENT from the CLI secret. It's persistent and should be used in production environment variables.
  </instructions>
  <verification>
    - Stripe Dashboard shows endpoint with 6 events selected
    - You have copied the signing secret
  </verification>
  <resume-signal>Type "configured" and provide: (1) the endpoint URL you used, (2) confirm you have the signing secret</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Create production environment documentation</name>
  <files>.planning/phases/19-stripe-production-setup/PRODUCTION-ENV.md</files>
  <action>
    Create PRODUCTION-ENV.md documenting all Stripe-related environment variables needed for production:

    ```markdown
    # Stripe Production Environment Variables

    ## Required Variables

    | Variable | Description | Source |
    |----------|-------------|--------|
    | STRIPE_SECRET_KEY | API secret key | Stripe Dashboard → Developers → API keys |
    | NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY | Public API key | Stripe Dashboard → Developers → API keys |
    | STRIPE_WEBHOOK_SECRET | Webhook signing secret | Stripe Dashboard → Webhooks → [endpoint] → Signing secret |
    | STRIPE_PRICE_ID_PLUS | Plus plan price ID | Stripe Dashboard → Products → Plus Plan → Price ID |
    | STRIPE_PRICE_ID_PRO | Pro plan price ID | Stripe Dashboard → Products → Pro Plan → Price ID |

    ## Test vs Live Mode

    **Test Mode (current):**
    - Keys start with `sk_test_` and `pk_test_`
    - Webhook secret from test endpoint
    - Uses test products/prices

    **Live Mode (production):**
    - Keys start with `sk_live_` and `pk_live_`
    - Must create new webhook endpoint for production domain
    - Must either:
      - Create new products in live mode, OR
      - Copy products from test to live in Stripe Dashboard

    ## Switching to Live Mode

    1. In Stripe Dashboard, toggle "Test mode" OFF (top right)
    2. Go to Developers → API keys → Copy live keys
    3. Go to Webhooks → Add new endpoint with production URL
    4. Go to Products → Create/copy products with live prices
    5. Update all environment variables in production hosting
    ```

    Include the actual test mode values currently in use (price IDs from .env.example).
  </action>
  <verify>PRODUCTION-ENV.md documents all required variables with sources</verify>
  <done>Production environment documentation created</done>
</task>

<task type="auto">
  <name>Task 4: Create go-live checklist</name>
  <files>.planning/phases/19-stripe-production-setup/PRODUCTION-CHECKLIST.md</files>
  <action>
    Create comprehensive PRODUCTION-CHECKLIST.md:

    ```markdown
    # Stripe Production Go-Live Checklist

    ## Pre-Launch (Test Mode Verification)

    - [ ] All webhook events tested locally with Stripe CLI
    - [ ] Full checkout flow tested: signup → checkout → subscription active
    - [ ] Subscription upgrade tested: Free → Plus → Pro
    - [ ] Subscription cancellation tested via Customer Portal
    - [ ] Payment failure handling tested (card 4000 0000 0000 0002)
    - [ ] Database correctly reflects all subscription state changes

    ## Production Setup

    ### Stripe Dashboard Configuration
    - [ ] Switch to Live mode in Stripe Dashboard
    - [ ] Create products in Live mode (or copy from Test)
      - Plus Plan: £10/month
      - Pro Plan: £20/month
    - [ ] Note Live mode price IDs
    - [ ] Create Live webhook endpoint: https://[domain]/api/stripe/webhook
    - [ ] Select events: checkout.session.completed, customer.subscription.*, invoice.payment_*
    - [ ] Copy Live webhook signing secret

    ### Hosting Environment Variables
    - [ ] Set STRIPE_SECRET_KEY to `sk_live_...`
    - [ ] Set NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY to `pk_live_...`
    - [ ] Set STRIPE_WEBHOOK_SECRET to Live webhook secret
    - [ ] Set STRIPE_PRICE_ID_PLUS to Live price ID
    - [ ] Set STRIPE_PRICE_ID_PRO to Live price ID

    ### Post-Launch Verification
    - [ ] Deploy application with Live credentials
    - [ ] Test webhook endpoint responds (Stripe Dashboard → Webhook → Send test webhook)
    - [ ] Create test subscription with real card (can refund immediately)
    - [ ] Verify subscription appears in database
    - [ ] Verify Customer Portal works for subscription management

    ## Rollback Plan

    If issues arise after go-live:
    1. Revert environment variables to test mode keys
    2. Deploy the change
    3. Investigate webhook logs in Stripe Dashboard
    4. Fix issues in test mode first
    5. Re-attempt go-live

    ## Monitoring

    - Stripe Dashboard → Developers → Webhooks shows delivery success/failure
    - Application logs show [Stripe Webhook] prefixed messages
    - Supabase subscriptions table reflects current state
    ```
  </action>
  <verify>PRODUCTION-CHECKLIST.md has all sections with actionable items</verify>
  <done>Go-live checklist created</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Production webhook configuration and go-live documentation</what-built>
  <how-to-verify>
    **Verify Stripe Dashboard webhook (if configured):**
    1. Go to https://dashboard.stripe.com/test/webhooks
    2. Find your endpoint - should show 6 events selected
    3. Click "Send test webhook" for `checkout.session.completed`
    4. Check that it shows as "Succeeded" (or "Failed" with reason if app not deployed)

    **Review documentation:**
    1. Open `.planning/phases/19-stripe-production-setup/PRODUCTION-ENV.md`
       - Variables documented with sources?
       - Test vs Live mode explained?

    2. Open `.planning/phases/19-stripe-production-setup/PRODUCTION-CHECKLIST.md`
       - Pre-launch items match our testing?
       - Production setup steps are actionable?
       - Rollback plan is clear?

    **Current Status Summary:**
    - Test mode: Fully working (webhooks via CLI, checkout, portal)
    - Production mode: Documented and ready (execute checklist when Phase 16 provides domain)
  </how-to-verify>
  <resume-signal>Type "approved" if documentation is complete, or note any missing items</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Decision made on production domain availability
- [ ] Webhook endpoint configured in Stripe Dashboard (test mode at minimum)
- [ ] PRODUCTION-ENV.md documents all required variables
- [ ] PRODUCTION-CHECKLIST.md provides actionable go-live steps
- [ ] Test webhook delivery verified in Dashboard (if endpoint reachable)
</verification>

<success_criteria>
- Stripe Dashboard webhook endpoint registered (test mode)
- Production environment variables fully documented
- Go-live checklist ready for Phase 16 completion
- All Phase 19 objectives met: test mode webhooks working, production documented
</success_criteria>

<output>
After completion, create `.planning/phases/19-stripe-production-setup/19-03-SUMMARY.md`
</output>
