---
phase: 19-stripe-production-setup
plan: 03
type: execute
wave: 3
depends_on: ["19-02"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "Production webhook endpoint exists in Stripe Dashboard"
    - "Webhook receives events at production URL and processes them"
    - "Production environment variables are documented and ready"
  artifacts:
    - path: ".planning/phases/19-stripe-production-setup/PRODUCTION-CHECKLIST.md"
      provides: "Go-live checklist and credential documentation"
    - path: ".planning/phases/19-stripe-production-setup/PRODUCTION-ENV.md"
      provides: "Environment variable documentation"
  key_links:
    - from: "Stripe Dashboard webhook"
      to: "production /api/stripe/webhook"
      via: "HTTPS POST with signature"
---

<objective>
Configure production webhook endpoint in Stripe Dashboard using agent-browser automation and document go-live checklist.

Purpose: Set up the production webhook so subscription events from real customers will sync to the database. Use agent-browser to automate Stripe Dashboard configuration where possible.
Output: Configured production webhook with go-live checklist ready for deployment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@.claude/skills/agent-browser/SKILL.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-stripe-production-setup/19-01-SUMMARY.md
@.planning/phases/19-stripe-production-setup/19-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check for production domain and decide approach</name>
  <files>n/a</files>
  <action>
    Check if a production URL is available:

    1. Look for Vercel deployment URL in project config or environment:
       ```bash
       # Check for VERCEL_URL or similar in .env files
       grep -r "VERCEL_URL\|NEXT_PUBLIC_URL\|PRODUCTION_URL" app/.env* 2>/dev/null || echo "No production URL found"
       ```

    2. Check if app is deployed to Vercel:
       ```bash
       # Check for vercel.json or .vercel folder
       ls -la app/vercel.json app/.vercel 2>/dev/null || echo "No Vercel config found"
       ```

    **Decision Logic:**
    - If production URL found → Proceed with full production webhook setup
    - If no production URL → Configure test mode webhook endpoint only, document production setup for later

    Record the decision and proceed accordingly.
  </action>
  <verify>Decision documented: either production URL identified or test-mode-only approach selected</verify>
  <done>Production domain status determined</done>
</task>

<task type="auto">
  <name>Task 2: Automate Stripe Dashboard webhook configuration with agent-browser</name>
  <files>n/a</files>
  <action>
    Use agent-browser to configure the webhook endpoint in Stripe Dashboard.

    **Note:** This requires the user to be logged into Stripe Dashboard in the browser. Agent-browser will automate the configuration steps.

    **Step 1: Open Stripe Dashboard webhooks page**
    ```bash
    agent-browser open https://dashboard.stripe.com/test/webhooks
    agent-browser wait --load networkidle
    agent-browser snapshot -i
    ```

    If login page appears (check snapshot for login form):
    - Take screenshot and inform user they need to log in manually
    - Wait for user to complete login, then continue

    **Step 2: Click "Add endpoint" button**
    ```bash
    agent-browser snapshot -i
    # Find and click "Add endpoint" button
    agent-browser find text "Add endpoint" click
    # Or use ref from snapshot: agent-browser click @addEndpointBtn
    agent-browser wait --load networkidle
    ```

    **Step 3: Fill endpoint configuration**
    ```bash
    agent-browser snapshot -i

    # Fill Endpoint URL (use production URL if available, otherwise use placeholder)
    # For test mode without production: use https://example.com/api/stripe/webhook as placeholder
    agent-browser find label "Endpoint URL" fill "https://YOUR_DOMAIN/api/stripe/webhook"

    # Add description
    agent-browser find label "Description" fill "AI Radiologist subscription webhooks"
    ```

    **Step 4: Select events to listen for**
    ```bash
    agent-browser snapshot -i

    # Click "Select events" or expand event selector
    agent-browser find text "Select events" click
    agent-browser wait 1000

    # Search and select each event type
    # checkout.session.completed
    agent-browser find placeholder "Search events" fill "checkout.session.completed"
    agent-browser find text "checkout.session.completed" click

    # Clear search and add next event
    agent-browser find placeholder "Search events" fill "customer.subscription"
    agent-browser find text "customer.subscription.created" click
    agent-browser find text "customer.subscription.updated" click
    agent-browser find text "customer.subscription.deleted" click

    # Add invoice events
    agent-browser find placeholder "Search events" fill "invoice.payment"
    agent-browser find text "invoice.payment_succeeded" click
    agent-browser find text "invoice.payment_failed" click
    ```

    **Step 5: Create the endpoint**
    ```bash
    agent-browser snapshot -i
    # Click "Add endpoint" to save
    agent-browser find role button click --name "Add endpoint"
    agent-browser wait --load networkidle
    ```

    **Step 6: Capture the signing secret**
    ```bash
    agent-browser snapshot -i
    agent-browser screenshot .playwright-mcp/stripe-webhook-created.png

    # Click on the endpoint to view details
    agent-browser find text "YOUR_DOMAIN" click
    agent-browser wait --load networkidle

    # Find and reveal signing secret
    agent-browser snapshot -i
    agent-browser find text "Reveal" click
    agent-browser wait 500

    # Take screenshot showing the secret (user will need to copy it)
    agent-browser screenshot .playwright-mcp/stripe-webhook-secret.png
    ```

    **Important:** The signing secret will be visible in the screenshot. User should copy it to their environment variables.

    If any step fails due to UI changes, take a snapshot and screenshot, then document what happened.
  </action>
  <verify>
    - Webhook endpoint created in Stripe Dashboard
    - 6 events selected
    - Signing secret revealed and captured in screenshot
  </verify>
  <done>Stripe Dashboard webhook configured via automation</done>
</task>

<task type="auto">
  <name>Task 3: Create production environment documentation</name>
  <files>.planning/phases/19-stripe-production-setup/PRODUCTION-ENV.md</files>
  <action>
    Read current .env.example to get actual test mode values:
    ```bash
    cat app/.env.example | grep -E "STRIPE|NEXT_PUBLIC_STRIPE"
    ```

    Create PRODUCTION-ENV.md documenting all Stripe-related environment variables needed for production:

    ```markdown
    # Stripe Production Environment Variables

    ## Required Variables

    | Variable | Description | Source |
    |----------|-------------|--------|
    | STRIPE_SECRET_KEY | API secret key | Stripe Dashboard → Developers → API keys |
    | NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY | Public API key | Stripe Dashboard → Developers → API keys |
    | STRIPE_WEBHOOK_SECRET | Webhook signing secret | Stripe Dashboard → Webhooks → [endpoint] → Signing secret |
    | STRIPE_PRICE_ID_PLUS | Plus plan price ID | Stripe Dashboard → Products → Plus Plan → Price ID |
    | STRIPE_PRICE_ID_PRO | Pro plan price ID | Stripe Dashboard → Products → Pro Plan → Price ID |

    ## Current Test Mode Values

    From `.env.example`:
    - STRIPE_PRICE_ID_PLUS: `[extracted value]`
    - STRIPE_PRICE_ID_PRO: `[extracted value]`

    ## Test vs Live Mode

    **Test Mode (current):**
    - Keys start with `sk_test_` and `pk_test_`
    - Webhook secret from test endpoint (whsec_...)
    - Uses test products/prices (price_...)

    **Live Mode (production):**
    - Keys start with `sk_live_` and `pk_live_`
    - Must create new webhook endpoint for production domain
    - Must either:
      - Create new products in live mode, OR
      - Copy products from test to live in Stripe Dashboard

    ## Switching to Live Mode

    1. In Stripe Dashboard, toggle "Test mode" OFF (top right corner)
    2. Go to Developers → API keys → Copy live keys
    3. Go to Webhooks → Add new endpoint with production URL
    4. Go to Products → Create/copy products with live prices
    5. Update all environment variables in production hosting (Vercel)

    ## Vercel Environment Variables Setup

    In Vercel Dashboard → Project → Settings → Environment Variables:

    | Variable | Environment | Value |
    |----------|-------------|-------|
    | STRIPE_SECRET_KEY | Production | sk_live_... |
    | NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY | Production | pk_live_... |
    | STRIPE_WEBHOOK_SECRET | Production | whsec_... (from production webhook) |
    | STRIPE_PRICE_ID_PLUS | Production | price_... (live mode) |
    | STRIPE_PRICE_ID_PRO | Production | price_... (live mode) |

    **Important:** Keep test mode variables for Preview/Development environments.
    ```
  </action>
  <verify>PRODUCTION-ENV.md documents all required variables with sources</verify>
  <done>Production environment documentation created</done>
</task>

<task type="auto">
  <name>Task 4: Create go-live checklist</name>
  <files>.planning/phases/19-stripe-production-setup/PRODUCTION-CHECKLIST.md</files>
  <action>
    Create comprehensive PRODUCTION-CHECKLIST.md:

    ```markdown
    # Stripe Production Go-Live Checklist

    ## Pre-Launch (Test Mode Verification)

    - [ ] All webhook events tested locally with Stripe CLI (Plan 19-01)
    - [ ] Full checkout flow tested: signup → checkout → subscription active (Plan 19-02)
    - [ ] Subscription upgrade tested: Free → Plus → Pro
    - [ ] Subscription cancellation tested via Customer Portal (Plan 19-02)
    - [ ] Payment failure handling tested (card 4000 0000 0000 0002)
    - [ ] Database correctly reflects all subscription state changes
    - [ ] TEST-RESULTS.md documents all test outcomes

    ## Production Setup

    ### Stripe Dashboard Configuration

    - [ ] Switch to Live mode in Stripe Dashboard (toggle in top right)
    - [ ] Create products in Live mode (or copy from Test)
      - Plus Plan: £10/month
      - Pro Plan: £20/month
    - [ ] Note Live mode price IDs (price_live_...)
    - [ ] Create Live webhook endpoint: `https://[your-domain]/api/stripe/webhook`
    - [ ] Select events:
      - `checkout.session.completed`
      - `customer.subscription.created`
      - `customer.subscription.updated`
      - `customer.subscription.deleted`
      - `invoice.payment_succeeded`
      - `invoice.payment_failed`
    - [ ] Copy Live webhook signing secret (whsec_...)

    ### Vercel Environment Variables

    - [ ] Set STRIPE_SECRET_KEY to `sk_live_...`
    - [ ] Set NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY to `pk_live_...`
    - [ ] Set STRIPE_WEBHOOK_SECRET to Live webhook secret
    - [ ] Set STRIPE_PRICE_ID_PLUS to Live price ID
    - [ ] Set STRIPE_PRICE_ID_PRO to Live price ID
    - [ ] Redeploy application to apply new variables

    ### Post-Launch Verification

    - [ ] Verify deployment successful with Live credentials
    - [ ] Test webhook endpoint via Stripe Dashboard:
      1. Go to Webhooks → Select endpoint
      2. Click "Send test webhook"
      3. Select `checkout.session.completed`
      4. Verify "Succeeded" status
    - [ ] Create real test subscription:
      1. Use a real card (personal card is fine)
      2. Complete checkout for Plus plan
      3. Verify subscription appears in database
      4. Cancel via Customer Portal
      5. Refund the charge in Stripe Dashboard
    - [ ] Verify Customer Portal works for subscription management

    ## Rollback Plan

    If issues arise after go-live:

    1. **Immediate:** Revert Vercel environment variables to test mode keys
    2. **Deploy:** Trigger redeployment with test credentials
    3. **Investigate:** Check Stripe Dashboard → Webhooks for delivery failures
    4. **Fix:** Debug and fix issues in test mode first
    5. **Re-launch:** Re-attempt go-live with fix

    ## Monitoring

    ### Stripe Dashboard
    - Webhooks page shows delivery success/failure per event
    - Events page shows all events sent to your endpoint
    - Filter by endpoint to see only your app's events

    ### Application Logs
    - All webhook handlers log with `[Stripe Webhook]` prefix
    - Check Vercel logs for webhook processing errors
    - Supabase Dashboard shows subscriptions table state

    ### Alerts to Set Up
    - [ ] Stripe email notifications for failed payments
    - [ ] Vercel deployment failure notifications
    - [ ] Consider adding error tracking (Sentry) for production

    ## Customer Support Scenarios

    | Issue | Resolution |
    |-------|------------|
    | "Payment failed" | Check Stripe Dashboard for decline reason, advise customer |
    | "Subscription not showing" | Check webhook logs, manually sync if needed |
    | "Can't access portal" | Generate new portal link via Stripe API |
    | "Wrong plan showing" | Check subscriptions table, compare with Stripe |
    ```
  </action>
  <verify>PRODUCTION-CHECKLIST.md has all sections with actionable items</verify>
  <done>Go-live checklist created</done>
</task>

<task type="auto">
  <name>Task 5: Verify webhook configuration with agent-browser</name>
  <files>n/a</files>
  <action>
    Use agent-browser to verify the webhook was configured correctly.

    **Step 1: Navigate to webhooks page**
    ```bash
    agent-browser open https://dashboard.stripe.com/test/webhooks
    agent-browser wait --load networkidle
    agent-browser snapshot -i
    agent-browser screenshot .playwright-mcp/stripe-webhooks-list.png
    ```

    **Step 2: Verify endpoint exists with correct events**
    ```bash
    # Click on the endpoint we created
    agent-browser snapshot -i
    agent-browser find text "api/stripe/webhook" click
    agent-browser wait --load networkidle

    # Take screenshot of endpoint details
    agent-browser screenshot .playwright-mcp/stripe-webhook-details.png
    ```

    **Step 3: Send test webhook**
    ```bash
    agent-browser snapshot -i

    # Find and click "Send test webhook" button
    agent-browser find text "Send test webhook" click
    agent-browser wait --load networkidle

    # Select checkout.session.completed event
    agent-browser snapshot -i
    agent-browser find text "checkout.session.completed" click

    # Click Send
    agent-browser find role button click --name "Send test webhook"
    agent-browser wait 3000

    # Capture result
    agent-browser snapshot -i
    agent-browser screenshot .playwright-mcp/stripe-test-webhook-result.png
    ```

    Document the test webhook result (succeeded/failed and why).

    **Step 4: Close browser**
    ```bash
    agent-browser close
    ```
  </action>
  <verify>
    - Screenshots captured showing webhook configuration
    - Test webhook sent and result documented
    - Browser session closed
  </verify>
  <done>Webhook configuration verified via automation</done>
</task>

<task type="auto">
  <name>Task 6: Document results and create summary</name>
  <files>.planning/phases/19-stripe-production-setup/19-03-SUMMARY.md</files>
  <action>
    Create the summary document for Plan 03:

    ```markdown
    # Plan 19-03 Summary: Production Webhook Configuration

    **Status:** [COMPLETE/PARTIAL]
    **Duration:** [X minutes]
    **Date:** [timestamp]

    ## What Was Done

    ### Stripe Dashboard Configuration
    - [ ] Webhook endpoint created at: [URL or "test mode placeholder"]
    - [ ] Events configured: 6 subscription lifecycle events
    - [ ] Signing secret: Captured (see screenshot)

    ### Documentation Created
    - [x] PRODUCTION-ENV.md - Environment variable reference
    - [x] PRODUCTION-CHECKLIST.md - Go-live checklist

    ### Verification
    - Test webhook sent: [SUCCEEDED/FAILED - reason]

    ## Screenshots

    - `.playwright-mcp/stripe-webhook-created.png` - Endpoint creation
    - `.playwright-mcp/stripe-webhook-secret.png` - Signing secret reveal
    - `.playwright-mcp/stripe-webhooks-list.png` - Webhooks list view
    - `.playwright-mcp/stripe-webhook-details.png` - Endpoint details
    - `.playwright-mcp/stripe-test-webhook-result.png` - Test webhook result

    ## Current State

    **Test Mode:**
    - Webhook endpoint: [Configured/Placeholder]
    - CLI forwarding: Working (from Plan 19-01)
    - E2E tests: Passing (from Plan 19-02)

    **Production Mode:**
    - Status: Documented and ready
    - Blocking: Production domain deployment (Phase 16)
    - Checklist: Complete and actionable

    ## Next Steps

    1. Complete Phase 16 (Vercel Deployment) to get production URL
    2. Execute PRODUCTION-CHECKLIST.md items
    3. Switch to Live mode and configure production webhook
    4. Verify with real payment test

    ## Issues/Notes

    [Any issues encountered or notes for future reference]
    ```
  </action>
  <verify>19-03-SUMMARY.md created with complete documentation</verify>
  <done>Plan 03 summary documented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Production domain status determined
- [ ] Webhook endpoint configured in Stripe Dashboard (or documented for later)
- [ ] PRODUCTION-ENV.md documents all required variables
- [ ] PRODUCTION-CHECKLIST.md provides actionable go-live steps
- [ ] Verification screenshots captured
- [ ] 19-03-SUMMARY.md created
</verification>

<success_criteria>
- Stripe Dashboard webhook endpoint configured (test mode at minimum)
- Production environment variables fully documented
- Go-live checklist ready for Phase 16 completion
- All Phase 19 objectives met: test mode webhooks working, production documented
</success_criteria>

<output>
After completion, the `.planning/phases/19-stripe-production-setup/19-03-SUMMARY.md` file documents all results.
</output>
